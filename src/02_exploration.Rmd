---
title: "Cleveland Baseball Game Duration"
subtitle: "Data Exploration"
author: "Michael Foley"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    highlight: tango
    css: "style.css"
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(scales)
library(ggtext)
library(extrafont)
# library(fpp3)
library(tsibble)
library(fable)
library(patchwork) # for arranging plots
library(glue)
library(png)
library(gridGraphics)
library(grid)
library(skimr)
library(ggrepel)
```

```{r data}
# Color schemes, utility functions.
source("00_setup.R")

# Experimenting with alternative markers on plots.
ball_png <- png::readPNG("../assets/baseball.png", native = TRUE)
ball_grob <- grid::rasterGrob(ball_png, interpolate = FALSE)

fig_no <- 0
```

Game times have crept upward from a little over two hours in the 1940s to an average of 3:16 in 2021. This project investigates the increase in game duration and the effect of recent efforts to quicken its pace. The primary data sources for this project are game and seasonal data scraped from [Baseball-Reference](https://www.baseball-reference.com/teams/CLE/2023.shtml) web pages, and the Major League Baseball (MLB) statistics application programming interface (API). This section is an overview of these data sources and what they might offer to the analysis. In addition to the insights that should guide the next steps, this script performs minor data engineering tasks to prep the data sets for model fitting. The output, in addition to many fancy plots, is two time-series tsibbles, `cle_season_ts` and `mlb_season_ts` saved in the project [data](https://github.com/mpfoley73/cleveland-mlb-games/tree/main/data) directory.

# Raw Data from Step 01 {.tabset .tabset-fade .tabset-pills}

Prior to running this report, I ran [01_get_bref_data.R](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/src/01_get_bref_data.R) and [01_get_mlb_data.R](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/src/01_get_mlb_data.R) to extract and aggregate the raw data. Load them here for exploration and engineering.

```{r echo=TRUE, class.source='fold-show'}
# Data from 01_get_bref_data.R.
cle_games <- readRDS("../data/cle_games.rds")
cle_batting <- readRDS("../data/cle_batting.rds")
cle_pitching <- readRDS("../data/cle_pitching.rds")

# Data from 01_get_mlb_data.R
mlb_pace <- readRDS("../data/mlb_pace.rds")
mlb_batting <- readRDS("../data/mlb_batting.rds")
mlb_pitching <- readRDS("../data/mlb_pitching.rds")

# Data from Retrosheet
retro_logs <- readRDS("../data/retro_logs.rds")
```

#### Baseball-Reference

R script **01_get_bref_data.R** scraped `r n_distinct(cle_games$season)` seasons of Cleveland baseball game summaries, including the 2023 season through `r format(max(cle_games$game_date), "%b %d")`, from Baseball-Reference. Baseball-Reference has a web page for each team's season. The pages include a table of game summaries. The R script loops through each season and scrapes the table. I ran it through all seasons through 2022, then set it to just refresh the 2023 season. _Run the script periodically to refresh this analysis_. Data set `cle_games` is a `r comma(nrow(cle_games))` x `r ncol(cle_games)` data frame with one row per each of the `r comma(nrow(cle_games))` games from 1901-1923. The Baseball-Reference pages also have player summaries which the R script also scrapes. `cle_batting` (`r comma(nrow(cle_batting))` x `r ncol(cle_batting)`) has seasonal stats for `r comma(length(unique(cle_batting$Name)), 1)` Cleveland batters. `cle_pitching` (`r comma(nrow(cle_pitching))` x `r ncol(cle_pitching)`) as stats for `r comma(length(unique(cle_pitching$Name)), 1)` pitchers. As you can see, the average big-league career spans only `r count(cle_batting, Name) %>% summarize(M = mean(n)) %>% pull(M) %>% comma(.1)` seasons for batters and `r count(cle_pitching, Name) %>% summarize(M = mean(n)) %>% pull(M) %>% comma(.1)` seasons for pitchers.

#### MLB API

The MLB API is publicly accessible. R package [baseballr](https://github.com/BillPetti/baseballr/) is an excellent tool. However, the API seems to have no public documentation, and changes functionality. I had trouble getting **baseballr** to work, probably because the API is a moving target. I was able to copy/paste the important code into my own script, **01_get_mlb_data.R**, and get the data I needed. One particularly useful module in the API is **gamePace**, an incredible set of metrics related to game pace. You can get data at the individual game level, or summarized by team. I originally wanted to focus on just Cleveland, but the team summaries only show the team's _home_ games. So if you want season summaries for a team, you really need _game_ summaries for all teams, then figure out which games Cleveland was the visiting team. This was just too much effort, so I shifted my focus to all MLB. As with **01_get_bref_data.R**, I used my MLB R script download all seasons through 2022, then I set it to just refresh 2023. _Run this script too when you refresh 2023_! Data set `mlb_pace` is a `r comma(nrow(mlb_pace))` x `r ncol(mlb_pace)` data frame with one row per each season, 1901-1923.

#### Retrosheet



Below, the **cle_games**, **cle_batting**, and **cle_pitching** tabs skim the data sets produced by **01_get_bref_data.R**. The **MLB-API** tab skims the data set produced by **01_get_mlb_data.R**. In **cle_games**, the `old_` columns are values coming into game day, and `new_` their value afterward. There **mlb_pace**, the time per pitch variable, `time_per_P`, varies a lot and does not seem reasonable.

## cle_games

```{r}
skimr::skim(cle_games)
```

## cle_batting

```{r}
skimr::skim(cle_batting)
```

## cle_pitching

```{r}
skimr::skim(cle_pitching)
```

## mlb_pace

```{r}
skimr::skim(mlb_pace)
```

## mlb_batting

```{r}
skimr::skim(mlb_batting)
```

## mlb_pitching

```{r}
skimr::skim(mlb_pitching)
```

# Create tsibbles

Summarize the three Cleveland data sets into season summaries, then combine them into a single data set, `cle_season_ts`. Most variables are related to the number of innings played, so standardize values to per-nine innings. Cast as a **tsibble** class from the **tsibble** package for time series analysis.

```{r echo=TRUE}
# key includes doubleheader game in order to index by game.
cle_games_ts <- cle_games %>%
  mutate(
    game_hours = dur / dhours(1),
    hours_per_9 = game_hours / innings * 9,
    game_runs = runs_scored + runs_allowed,
    runs_per_9 = game_runs / innings * 9
  ) %>% 
  relocate(any_of(c("game_runs", "runs_per_9")), .after = 15) %>%
  relocate(any_of(c("game_hours", "hours_per_9")), .after = 22) %>%
  tsibble(key = c(doubleheader_game), index = game_date)

cle_batting_ts <- cle_batting %>%
  # Singles are used in SLG calc.
  mutate(`1B` = H - (`2B` + `3B` + HR)) %>%
  relocate(`1B`, .before = 10) %>%
  summarize(.by = season, across(c(PA:SO, TB:IBB), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    BA = H / AB,
    OBP = (H + BB + HBP) / (AB + BB + HBP + SF),
    SLG = (`1B` + 2*`2B` + 3*`3B` + 4*HR) / AB,
    OPS = OBP + SLG
  ) %>%
  rename_with(~ paste0("batting_", .x), c(PA:OPS)) %>%
  tsibble(index = season)

cle_pitching_ts <- cle_pitching %>%
  summarize(.by = season, across(c(G:BF), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    ERA = 9 * ER / IP,
    WHIP = (BB + H) / IP,
    H_per_9 = 9 * H / IP,
    HR_per_9 = 9 * HR / IP,
    BB_per_9 = 9 * BB / IP,
    SO_per_9 = 9 * SO / IP
  ) %>%
  select(-c(GS, GF, SV)) %>%
  rename_with(~ paste0("pitching_", .x), c(G:SO_per_9)) %>%
  tsibble(index = season)

# `cle_games_ts` is at the game granularity. Summarize it to the season level
# and combine with the batting and pitching season summaries to create a singe 
# tsibble.

summarize_games <- function(dat) {
  dat %>% summarize(
    avg_hours = mean(game_hours, na.rm = TRUE),
    hours_per_9 = mean(hours_per_9, na.rm = TRUE),
    avg_home_attendance = mean(if_else(home_ind == "Home", attendance, NA_real_), na.rm = TRUE),
    wins = sum(str_sub(outcome, 1, 1) == "W"),
    losses = sum(str_sub(outcome, 1, 1) == "L"),
    avg_runs_per_9 = mean(runs_per_9),
    innings = sum(innings),
    place = last(new_rank),
    games = n(),
    home_games = sum(home_ind == "Home"),
    away_games = sum(home_ind == "Away")
  )
}

cle_season_ts <- cle_games_ts %>%
  arrange(season, game_no) %>% #filter(season == 2020)
  index_by(season = ~ year(.)) %>%
  summarize_games() %>%
  mutate(winning_pct = wins / (wins + losses)) %>%
  relocate(c(winning_pct, place), .after = 6) %>%
  inner_join(cle_batting_ts, join_by(season)) %>%
  mutate(
    batting_PA_per_9 = batting_PA / innings * 9,
    batting_SB_per_9 = batting_SB / innings * 9,
    batting_CS_per_9 = batting_CS / innings * 9,
    batting_H_per_9 = batting_H / innings * 9,
    batting_HR_per_9 = batting_HR / innings * 9,
    batting_BB_per_9 = batting_BB / innings * 9,
    batting_SO_per_9 = batting_SO / innings * 9
  ) %>%
  inner_join(cle_pitching_ts, join_by(season))
```

The `mlb_pace` data set is already at the season granularity. The `mlb_batting` and `mlb_pitching` data sets are at the team-season granularity. Summarize by season and casts to a tsibble.

```{r echo=TRUE}
mlb_batting_ts <- mlb_batting %>%
  # Singles are used in SLG calc.
  mutate(`1B` = H - (`2B` + `3B` + HR)) %>%
  relocate(`1B`, .before = 6) %>%
  summarize(.by = season, across(c(G:HBP, AB, SB:PA, TB:K), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    P = if_else(season <= 1973, NA_integer_, P),
    K = if_else(season <= 1909, NA_integer_, K),
    BA = H / AB,
    OBP = (H + BB + HBP) / (AB + BB + HBP + sac_bunts),
    SLG = (`1B` + 2*`2B` + 3*`3B` + 4*HR) / AB,
    OPS = OBP + SLG
  ) %>%
  rename_with(~ paste0("batting_", .x), c(G:OPS)) %>%
  tsibble(index = season)

mlb_pitching_ts <- mlb_pitching %>%
  summarize(.by = season, across(c(G:HBP, AB, IP:ER, BF:wild_pitches), ~sum(.x, na.rm = TRUE))) %>%
  rename_with(~ paste0("pitching_", .x), c(G:wild_pitches)) %>%
  tsibble(index = season)

mlb_pace_ts <- tsibble(mlb_pace, index = season)

mlb_season_ts_0 <- mlb_pace_ts %>%
  inner_join(mlb_batting_ts, by = join_by(season)) %>%
  inner_join(mlb_pitching_ts, by = join_by(season)) %>%
  mutate(
    PA_per_G = PA / G,
    PA_per_9 = PA / I * 9,
    PA_per_pitcher = PA / pitchers,
    pitchers_per_G = pitchers / G,
    pitchers_per_9 = pitchers / I * 9,
    pitchers_per_PA = pitchers / PA,
    #new
    P_per_G = P / G,
    P_per_9 = P / I * 9,
    P_per_PA = P / PA,
    P_per_pitcher = P / pitchers,
    R_per_G = R / G,
    R_per_9 = R / I * 9,
    H_per_9 = H / I * 9,
    BB_per_9 = batting_BB / I * 9,
    K_per_9 = pitching_K / I * 9,
    SB_per_9 = batting_SB / I * 9,
    CS_per_9 = batting_CS / I * 9,
    H_per_9 = H / I * 9,
    HR_per_9 = batting_HR / I * 9,
    BB_per_9 = batting_BB / I * 9,
    K_per_9 = pitching_K / I * 9,
    P_per_9 = P / I * 9,
    ERA = pitching_ER / I * 9 / 2, # two pitchers
    WHIP = (batting_BB + H) / I / 2 # two pitchers
  ) %>%
  select(-c(batting_G, pitching_G, batting_H, pitching_H,
            batting_R, pitching_R, batting_PA, pitching_BF,
            pitching_HR, pitching_BB, batting_K, batting_HBP, pitching_AB,
            pitching_W, pitching_L, pitching_IP, batting_P, pitching_P,
            pitching_outs, pitching_GS)) %>%
  rename_with(~str_remove(.x, "batting_"), c(batting_1B:batting_BB, batting_AB:batting_OPS)) %>%
  rename_with(~str_remove(.x, "pitching_"), c(pitching_K, pitching_HBP:pitching_wild_pitches)) %>%
  relocate(K, .after = "BB")
```

# Coverage and Quality {.tabset .tabset-fade .tabset-pills}

Almost all features are fully populated, but there are several exceptions.

Attendance for game two of a double-header is recorded as zero, but many games through 1936 have no recorded attendance. The plot in **CLE Attend.** excludes the double-header game two. Cleveland game duration is spotty before 1940 (**CLE Duration**).

The pitch count per game (**MLB Pitches**) is potentially among the most important variables, but unfortunately the data is not populate until 1950. And even then, something is very wrong about the values before 1988. Furthermore, the 1988-1998 values are suspiciously noisy. I will null out the pre-1999 values for `total_P`.

The `total_time` and `extra_I_time` columns have issues (**MLB Duration**). Something is obviously wrong with several data points prior to 1930. Imputing values gives more reasonable values (**Imputed Durations**).

The stolen bases data does not pass the eyeball test prior to 1950. Stolen bases seem reasonable with the exception of 1914-15. Caught stealing

## CLE Attend.

```{r}
cle_games_ts %>%
  filter(doubleheader_game == 0, home_ind == "Home") %>%
  index_by(season = ~ year(.)) %>%
  summarize(na_attendance = sum(if_else(is.na(attendance), 1, 0))) %>%
  ggplot(aes(x = season, y = na_attendance)) + 
  geom_col(width = 1.0, fill = "#E31937", alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  annotate(
    geom = "curve", x = 2012, y = 35, xend = 2017, yend = 25, 
    curvature = .10, arrow = arrow(length = unit(2, "mm")),
    color = "#0C2340"
  ) +
  annotate(
    geom = "text", x = 2007, y = 38, label = "COVID", size = 3.5, 
    family = "Rockwell Condensed", hjust = "left", color = "#0C2340") +
  coord_cartesian(ylim = c(0, 80)) +
  labs(
    title = "Cleveland attendance data is not reliable until 1937.",
    subtitle = "Games with no recorded attendance.",
    x = NULL, y = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Cleveland home games with no recorded attendance</b>. Data is not reliably recorded until 1937. Note that the 2020 season was partial and played with no in-person spectators due to the Covid pandemic.<br>Source: www.baseball-reference.com.</font>

## CLE Duration

```{r}
cle_games_ts %>%
  index_by(season = ~ year(.)) %>%
  group_by(season) %>%
  summarize(na_duration = sum(if_else(is.na(dur), 1, 0))) %>%
  ggplot(aes(x = season, y = na_duration)) + 
  geom_col(width = 1.0, fill = "#E31937", alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(
    title = "Cleveland game duration data is not reliable until 1920.",
    subtitle = "Games with no recorded duration.",
    x = NULL, y = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Cleveland games with no recorded duration</b>. Data is not reliably recorded until 1920.<br>Source: www.baseball-reference.com.</font>

## MLB Pitches

```{r warning=FALSE}
mlb_season_ts_0 %>%
  mutate(
    status = factor(
      case_when(season < 1988 ~ "Definitely bad",
                season < 1999 ~ "Suspicious",
                TRUE ~ "Probably good"),
      levels = c("Definitely bad", "Suspicious", "Probably good")
    )
  ) %>%
  ggplot(aes(x = season, y = P_per_9, color = status)) + 
  geom_point() +
  scale_color_manual(values = c("#E31937", "#efb21e", "#003831")) +
  labs(
    title = "MLB pitch count data is not reliable until 1999.", 
    subtitle = "Average pitches per nine innings.",
    x = NULL, y = NULL, color = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. MLB pitches per nine innings</b>. There is no recorded pitch counts until 1950 and until 1988 the values are less than half of what seems reasonable. The 1988-1998 values are still low and variable. Only 1999-present are consistent. <b>Source: MLB Stats API</b>.</font>

## MLB Duration

```{r}
suspicious_seasons <- c(1902, 1903, 1904, 1907, 1918, 1919, 1928, 1929)
mlb_season_ts_0 %>%
  mutate(
    dur_per_9 = time_length(dur / I * 9, "hours"),
    status = if_else(season %in% suspicious_seasons, "Suspicious", "Probably good"),
    status = factor(status, levels = c("Suspicious", "Probably good"))
  ) %>%
  ggplot(aes(x = season, y = dur_per_9, color = status)) + 
  geom_point() +
  scale_color_manual(values = c("#efb21e", "#003831")) +
  scale_y_continuous(labels = pretty_hm, limits = c(0, 3.5)) +
  labs(
    title = "Several game duration points are suspicious.",
    subtitle = "Hours per nine innings.",
    x = NULL, y = NULL, color = NULL
  ) +
  theme(legend.position = "top")
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. MLB game duration data has several outliers</b>. Eight values are suspicious, the most recent in 1928 and 1929. <br>Source: MLB Stats API.</font>

## Imputed Durations

```{r warning=FALSE, echo=TRUE}
# Remove everything related to pitch counts prior to 1999.
mlb_season_ts_1 <- mlb_season_ts_0 %>%
  mutate(P = if_else(season < 1999, NA_real_, P))

# Remove bad values from time columns
mlb_season_ts_2 <- mlb_season_ts_1 %>%
  mutate(across(c(dur, extra_I_dur), ~if_else(season %in% suspicious_seasons, NA, .x)))

# Use MICE to impute values in the time cols
imp_total_time <- mlb_season_ts_2 %>%
  # select(-c(extra_I_dur, P, `1B`:`3B`, ends_with("per_9"))) %>%
  select(dur, I, PA, pitchers, K, BB, season) %>%
  mice::mice(print = FALSE, seed = 123) %>%
  complete()

imp_extra_I_time <- mlb_season_ts_2 %>%
  # select(-c(dur, P)) %>%
  select(extra_I_dur, extra_I_G) %>%
  mice::mice(print = FALSE, seed = 123) %>%
  complete()

mlb_season_ts_3 <- mlb_season_ts_2
mlb_season_ts_3$dur <- imp_total_time$dur
mlb_season_ts_3$extra_I_dur <- imp_extra_I_time$extra_I_dur
```

```{r}
mlb_season_ts_3 %>%
  mutate(
    dur_per_9 = time_length(dur / I * 9, "hours"),
    status = if_else(season %in% suspicious_seasons, "Imputed", "Probably good"),
    status = factor(status, levels = c("Imputed", "Probably good"))
  ) %>%
  ggplot(aes(x = season, y = dur_per_9, color = status)) + 
  geom_point() +
  scale_color_manual(values = c("#efb21e", "#003831")) +
  scale_y_continuous(labels = pretty_hm, limits = c(0, 3.5)) +
  labs(title = "Outlier game durations with imputed values", x = NULL, y = NULL, color = NULL,
       subtitle = "Minutes per plate appearance") +
  theme(legend.position = "top")
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. MLB game duration data with imputed values for outliers</b>. Values imputed with [MICE](https://mpfoley73.netlify.app/post/2022-07-26-imputing-values-with-mice/). <br>Source: MLB Stats API.</font>

## Stolen Bases

```{r warning=FALSE}
mlb_season_ts_3 %>% 
  pivot_longer(cols = c(SB_per_9, CS_per_9)) %>%
  ggplot(aes(x = season, y = value, color = name)) +
  geom_point() +
  scale_color_manual(values = c("#003831", "#fd5a1e")) +
  labs(
    title = "Stolen base data is suspicious prior to 1953.",
    subtitle = "Stolen bases per nine innings (points) and success rate (area).",
    x = NULL, y = "Count", color = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. MLB pitches per nine innings</b>. There is no recorded pitch counts until 1950 and until 1988 the values are less than half of what seems reasonable. The 1988-1998 values are still low and variable. Only 1999-present are consistent. <b>Source: MLB Stats API</b>.</font>

# Feature Engineering

As with the Baseball Reference data, I will standardize the MLB data into per-nine-innings and other related levels.

```{r echo=TRUE, class.source='fold-show'}
mlb_season_ts <- mlb_season_ts_3 %>%
  mutate(
    dur_per_G = dur / G,
    dur_per_9 = dur / I * 9,
    dur_per_PA = dur / PA,
    dur_per_P = dur / P,
    dur_per_R = dur / R,
    hrs_per_G = time_length(dur_per_G, "hours"),
    hrs_per_9 = time_length(dur_per_9, "hours"),
    min_per_PA = time_length(dur_per_PA, "minutes"),
    sec_per_P = time_length(dur_per_P, "seconds")
  )
```

# Feature Exploration

These subsections take a closer look at the features in the data set. The main purpose is characterize the relationships with the `hours_per_9` outcome variable, and possibly reduce the field of explanatory variables. Some variables, like `avg_home_attendance`, are not useful toward understanding game duration, but are worth a look just because they are interesting.

## Attendance

Attendance data is spotty prior to 1940, so perhaps we should take the season averages with a grain of salt for those years. Also, attendance is constrained by the park capacity. Attendance might have been higher, at least in the 1990s when Cleveland sold out 455 straight games from 6/12/1995 through 4/2/2001. Here is a brief look at capacity:

- [League Park](https://en.wikipedia.org/wiki/League_Park) was built in 1891 and seated 9,000. The Spiders played their until folding after the 1899 season. The Indians (originally the Blues) started in 1901. In 1910 the park was rebuilt with concrete and steel with 18,000 seats.
- Municipal Stadium opened in 1932. The Indians played there from July 1932 through 1933, but returned to League Park in 1934 because attendance didn't justify such a large facility. Beginning in 1937, the Indians played weekend and holiday games at Municipal stadium and gradually added more dates. Beginning in 1947 all games were played there.
- [Progressive Field](https://en.wikipedia.org/wiki/Progressive_Field) (named Jacobs Field from 1994-2007) opened in 1994 with a capacity of 42,865. Modifications increased capacity to 45,199 in 2009. Other modifications in 2011 reduced to 43,441, then 36,856 in 2015, and 34,830 in 2021.

Attendance is generally correlated with winning, but something seems wrong with the two World Series years, 1948 and 1954. Average attendance in 1947, the first full season at Municipal Stadium, was 25,300. The Tribe finished 80-74 that year. The next season the Tribe went 97-58 and went on to win the World Series. Average attendance swelled to 40,300. Despite finishing 89-65 in 1949, attendance fell to 36,300, then to 26,700 in 1950. It continued to fall each season, reaching a low of 16,800 in 1953, despite 90+ wins each year. The 1954 season, with the gaudy 111-43 record only lifted attendance to 20,000 per game. It resumed its decline the next season. It briefly rebounded to 23,800 in 1959, but would not exceed 20,000 again until 1993.

```{r}
SF <- 50000
(step_2_fig1 <- cle_season_ts %>%
  mutate(attend = if_else(season == 2020, 0, avg_home_attendance)) %>%
  ggplot(aes(x = season, y = attend)) +
  geom_col(aes(y = 1 * SF), fill = "#0C2340", width = 1, alpha = 0.05) +
  geom_col(aes(y = wins / (wins + losses) * SF), fill = "#0C2340", width = 1, alpha = 0.2) +
  geom_line(color = "#E31937", na.rm = TRUE, linewidth = 1) +
  geom_point(aes(y = if_else(season %in% c(1920, 1948, 1954, 1995, 1997, 2016), attend, NA_real_)),
             shape = 21, color = "#E31937", fill = "white", size = 3, na.rm = TRUE) +
  geom_hline(yintercept = 0.50 * SF, linetype = 3, linewidth = 1, color = "#0C2340") +
  annotate(
    geom = "curve", x = 1960, y = 28000, xend = 1954, yend = 22000, 
    curvature = .3, arrow = arrow(length = unit(2, "mm")),
    color = "#0C2340"
  ) +
  annotate("text", x = 1961, y = 28000, label = "1954", size = 3, 
           hjust = "left", color = "#0C2340") +
  scale_y_continuous(limits = c(0, NA), 
                     labels = scales::comma,
                     expand = c(0,0),
                     sec.axis = sec_axis(trans = ~ .x / SF,
                                         labels = scales::percent_format(),
                                         name = "Winning Percentage")) +
  scale_x_continuous(breaks = seq(1900, 2030, 10), expand = c(0,0)) +
  labs(
    x = NULL, y = "Fans per Game",
    title = "Attendance usually increases with performance.",
    subtitle = "Cleveland average home attendance and winning percentage."
  ) +
  theme(
    axis.text.y.left = element_text(color = "#E31937"),
    axis.title.y.left = element_text(color = "#E31937", margin = margin(r = 5)),
    axis.title.y.right = element_text(color = "#0C2340", margin = margin(l = 5))
  )
)
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Cleveland average home attendance and winning percentage</b>. Attendance is generally accompanies improved play. World Series appearances years are highlighted. 1948 and 1954 stand out. 1948 is incredibly high relative to other winning seasons, and 1954 is low considering the dominant performance. <br>Source: www.baseball-reference.com.</font>

As an aside, check out 1917 and 1918. Game attendance does not seem unusual those two years despite WWI and the influenza pandemic. The US entered WWI in Apr '17 and the war ended after the season concluded in '18. The 1918 influenza pandemic started in the spring, but seems to have really taken off around October. Baseball survived the war as an acceptable diversion from civic duty, and in fact patriotic elements were integrated into the games.

## Game Duration {.tabset}

```{r}
max_avg <- mlb_season_ts %>% slice_max(order_by = dur_per_9)
avg_2023 <- mlb_season_ts %>% filter(season == 2023)
max_m_23 <- time_length(max_avg[1, ]$dur_per_9 - avg_2023[1, ]$dur_per_9, "minute")
```

Games typically lasted around two hours up to 1945. Then over the course of ten seasons game times increased to 2.5 hours. In the late 1970s games began increasing again, peaking at `r max_avg %>% pull(hrs_per_9) %>% pretty_hm(verbose = TRUE)` in `r max_avg %>% pull(season)`. Significant changes in 2023 appear to have halted the advance. Average game times in 2023 have been `r avg_2023 %>% pull(hrs_per_9) %>% pretty_hm(verbose = TRUE)` year to date, a `r comma(max_m_23)` minute reduction. Doug Pappas chronicled the increased playing times in the Summer 1995 issue of Outside the Lines, the SABR Business of Baseball Committee newsletter. Pappas found a Sporting News article from 1962 blaming longer game times on full counts, pitching changes, and delays between pitches.^[Doug Pappas. Originally published in the Summer 1995 issue of Outside the Lines, the SABR Business of Baseball Committee newsletter. [html](http://roadsidephotos.sabr.org/baseball/95gamelength.htm).]

Average game duration does not appear to change much within seasons.  

### By Year

```{r}
knot_yrs <- c(1944, 1955, 1978, 2021, 2023)

model(mlb_season_ts, TSLM(hrs_per_9 ~ trend(knots = knot_yrs))) %>%
  augment() %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hrs_per_9), color = "#003831", linewidth = 1) +
  geom_line(aes(y = .fitted), color = "#fd5a1e", linetype = 2, linewidth = .5) +
  geom_text(data = mlb_season_ts %>% filter(season %in% knot_yrs), 
            aes(y = hrs_per_9 + if_else(season == 2021, +.15, -.15), label = pretty_hm(hrs_per_9)), 
            family = "Rockwell", size = 3.5, color = "#003831", hjust = 0) + 
  geom_point(data = mlb_season_ts %>% filter(season %in% knot_yrs), 
             aes(y = hrs_per_9),
             color = "#fd5a1e", size = 2) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 8, labels = pretty_hm) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(
    title = "Game duration increased in two phases: 1945-1955 and 1979-2021.",
    subtitle = "Average game duration per nine innings, 1901-2023",
    x = NULL, y = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Average elapsed time per nine innings of play</b>. Average elapsed time was stable at around two hours until a dramatic increase of 30 minutes from 1945-1955. Another 30 minutes were added between 1979 and 2000, peaking at `r max_avg %>% pull(hrs_per_9) %>% pretty_hm(verbose = TRUE)` in `r max_avg %>% pull(season)`.</font>

### CLE

```{r}
model(cle_season_ts, TSLM(hours_per_9 ~ trend(knots = knot_yrs))) %>%
  augment() %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), color = "#0C2340", linewidth = 1) +
  geom_line(aes(y = .fitted), color = "#E31937", linetype = 2, linewidth = .5) +
  geom_text(data = cle_season_ts %>% filter(season %in% knot_yrs), 
            aes(y = hours_per_9 + if_else(season == 2021, +.15, -.15), label = pretty_hm(hours_per_9)), 
            family = "Rockwell", size = 3.5, color = "#0C2340", hjust = 0) + 
  geom_point(data = cle_season_ts %>% filter(season %in% knot_yrs), 
             aes(y = hours_per_9),
             color = "#E31937", size = 2) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 8, labels = pretty_hm) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(
    title = "Cleve game duration increased in two phases: 1945-1955 and 1979-2021.",
    subtitle = "Average game duration per nine innings, 1901-2023",
    x = NULL, y = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Cleveland average elapsed time per nine innings of play</b>. Cleveland game duration data follow the MLB Stats API values.</font>

### By Month in Year

```{r warning=FALSE}
cle_tsibble_yrmo <- cle_games_ts %>%
  index_by(yrmo = ~ yearmonth(.)) %>%
  summarize_games()

cle_tsibble_mmm <- cle_games_ts %>%
  index_by(mmm = ~ month(.)) %>%
  summarize_games() %>%
  mutate(mmm = ym(paste0("9999-", mmm)))

ggplot() +
  geom_line(data = cle_tsibble_yrmo,
            aes(x = month(yrmo, label = TRUE, abbr = TRUE), y = hours_per_9,
                group = factor(year(yrmo)), color = year(yrmo)),
            show.legend = TRUE, alpha = 0.2) +
  scale_color_gradient(low = "#0C2340", high = "#E31937") +
  geom_line(data = cle_tsibble_mmm,
            aes(x = month(mmm, label = TRUE, abbr = TRUE), y = hours_per_9,
                group = factor(year(mmm))), 
            alpha = 0.8) +
  scale_y_continuous(limits = c(0, NA), labels = pretty_hm) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.25)) +
  labs(
    title = "Cleveland Game duration falls slightly within a season.",
    subtitle = "Game duration per nine innings by month of season.", 
    x = NULL, y = NULL, color = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Cleveland average elapsed time per nine innings of play by month of year</b>. Bold line is average. Duration falls about .2 hours (12 minutes) over the course of the season. The apparent increase in March game times is an artifact of March games not occurring until 1998.<br> source: www.baseball-reference.com.</font>

## Doubleheaders {.tabset}

```{r}
double_header <- cle_games_ts %>%
  mutate(doubleheader_ind = if_else(doubleheader_game == 0, "Single Game", "Doubleheader")) %>%
  index_by(season = ~ year(.)) %>%
  group_by(season, doubleheader_ind) %>%
  summarize(hours_per_9 = mean(hours_per_9, na.rm = TRUE), n = n())

double_header_effect <- double_header %>%
  as_tibble() %>%
  pivot_wider(id_cols = season, names_from = doubleheader_ind, values_from = hours_per_9) %>%
  mutate(twin_diff = `Doubleheader` - `Single Game`)
```

Prior to 1942, a few doubleheaders would be scheduled each season. There doesn't appear to be a pattern: it might be on a Tuesday, for instance. Sunday doubleheaders became common in 1942, either scheduled or as make-ups. In 1943, most Sundays were scheduled doubleheaders and over 50% of baseball games overall were part of a doubleheader. Scheduled doubleheaders, esp. Sundays, were common through 1978. After that, only two or three might be scheduled.

Doubleheaders have become less common while game times have increased. Is there a negative correlation, perhaps a compensating effect? The answer is no, doubleheaders are irrelevant. The average doubleheader game is shorter by only `r scales::comma(mean(double_header_effect$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)` minutes.

```{r}
SF <- 50 # scaling factor for sec.axis.
double_header %>%
  ggplot(aes(x = season)) +
  geom_col(aes(y = n / SF, fill = fct_rev(doubleheader_ind)), alpha = 0.2, width = 1.0) +
  geom_line(aes(y = hours_per_9, color = fct_rev(doubleheader_ind)), linewidth = 1) +
  scale_color_manual(values = as.character(pal_cle)) +
  scale_fill_manual(values = as.character(pal_cle)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4, labels = pretty_hm,
    sec.axis = sec_axis(trans = ~ .x * SF, labels = comma_format(), name = "Games Played")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       titletitle = glue("Doubleheader games are shorter by only {scales::comma(mean(double_header_effect$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)} minutes on average."),
       subtitle = "Cleveland doubleheader game duration.",
       caption = "source: www.baseball-reference.com.") +
  theme(
    legend.position = "top",
    axis.title.y.right = element_text(margin = margin(l = 5))
  )
```

## Night Games

```{r}
day_night <- cle_games_ts %>%
  index_by(season = ~ year(.)) %>%
  group_by(season, day_ind) %>%
  summarize(hours_per_9 = mean(hours_per_9, na.rm = TRUE), n = n())
```

Until the late 1930s, all games were played in the afternoon. By the mid 1970s day games were primarily on weekends. While there might be a different dynamic to paying in the afternoon (*it's hot - let's get out of here!*), the data doesn't bear that out. The advent of night games is not associated with longer games.

```{r}
SF <- 50 # scaling factor for sec.axis.
day_night %>%
  ggplot(aes(x = season)) +
  geom_col(aes(y = n / SF, fill = day_ind), alpha = 0.2, width = 1.0) +
  geom_line(aes(y = hours_per_9, color = day_ind), linewidth = 1) +
  scale_color_manual(values = as.character(pal_cle)) +
  scale_fill_manual(values = as.character(pal_cle)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4, labels = pretty_hm,
    sec.axis = sec_axis(trans = ~ .x * SF, labels = comma_format(), name = "Games Played")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Night games are more common, but they're not longer.",
       subtitle = "Cleveland Indians average game duration, with periods of growth and stability.",
       caption = "source: www.baseball-reference.com.") +
  theme(
    legend.position = "top",
    axis.title.y.right = element_text(margin = margin(l = 5))
  )
```

## Offense {.tabset}

```{r include=FALSE}
max_K <- mlb_season_ts %>% filter(K_per_9 == max(mlb_season_ts$K_per_9))

# Fit a univariate OLS and pull the R^2. R^2 is .81!
lm_K <- lm(hrs_per_9 ~ log(K_per_9), data = mlb_season_ts)
r2_K <- broom::glance(lm_K) %>% pull(adj.r.squared)
# The plot has evidence of autocorrelation - there are other factors impacting
# the trend. Including a t-1 term increases R^2 to .95. The standard error of 
# the regression is .10 - about 6 minutes.
lm_K_trend <- mlb_season_ts %>% model(TSLM(hrs_per_9 ~ log(K_per_9) + trend()))
lm_K_trend %>% report()
```

The number of plate appearances per game has not changed much over time (Fig. `r (fig_no + 1)`). However, the offensive outcomes have (Fig. `r (fig_no + 2)`). Strikeouts in particular have increased with game times and alone can explain about `r percent(r2_K, 1)` of the variation in average game duration (Fig. `r (fig_no + 2)`). 

### PA Trend

```{r warning=FALSE}
mlb_season_ts %>%
  ggplot(aes(x = season)) +
  geom_area(aes(y = hrs_per_9 * 30), fill = "gray20", alpha = .10) +
  geom_line(aes(y = PA_per_9), linewidth = 1) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(
    limits = c(0, NA), 
    sec.axis = sec_axis(trans = ~ . / 30, labels = comma_format(.1), breaks = 25/30 * c(1:4), name = "hours per 9")
  ) +
  labs(
    title = "Plate appearances have not changed much.",
    subtitle = "Plate appearances (line) and game duration (shaded), per nine-innings.",
    x = NULL, y = "PA per 9 innings", color = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Plate appearances (line) and game duration (shaded), per nine-innings</b>. The amount of game activity, summarized here by plate appearances, has changed little and is an unlikely explanation for the long term trend in game duration.<br> source: MLB Stats API.</font>

### Walks, Hits, K's

```{r}
mlb_season_ts %>%
  pivot_longer(cols = c(H_per_9, K_per_9, BB_per_9)) %>%
  ggplot(aes(x = season)) +
  geom_area(data = mlb_season_ts, aes(y = hrs_per_9 * 6.5), fill = "gray20", alpha = .10) +
  geom_line(aes(y = value, color = name), linewidth = 1) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(
    limits = c(0, NA), 
    sec.axis = sec_axis(trans = ~ . / 6.5, labels = comma_format(.1), breaks = 5/6.5 * c(1:4), name = "hours per 9")
  ) +
  scale_color_discrete(labels = c(BB_per_9 = "Walks", H_per_9 = "Hits", K_per_9 = "K's", R_per_9 = "Runs")) +
  labs(
    title = "Strikeouts are correlated with game duration.",
    subtitle = "Offensive metrics (lines) and game duration (shaded), per nine-innings.",
    x = NULL, y = "Count per 9 innings", color = NULL
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Offensive metrics (lines) and game duration (shaded), per nine-innings</b>. Of the main offense metrics, strikeouts come closest to matching the trend in game duration. In fact, strikeouts alone explain about `r percent(r2_K, 1)` of the variation in average game duration. Strikeouts climbed gradually after the dead-ball era, then more sharply after WWII. They declined from the mid-60's to 1980, but have climbed since then, peaking at `r comma(max_K[1, ]$K_per_9, .1)` in `r max_K[1, ]$season`.<br>Source: MLB Stats API.</font>

### K-Duration Correlation

```{r warning=FALSE}
bind_cols(
  mlb_season_ts[, c("season", "K_per_9")], 
  broom::augment(lm_K)
) %>%
  mutate(influential = .cooksd > 4 * mean(.cooksd)) %>%
  ggplot(aes(x = log(K_per_9), y = hrs_per_9)) +
  geom_point(aes(color = influential), show.legend = FALSE) +
  geom_text_repel(aes(label = if_else(influential, season, NA_real_))) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  labs(
    title = "Strikeouts are correlated with longer game times.",
    subtitle = glue("Adjusted R2 = {comma(glance(lm_K)[1, ]$adj.r.squared, .01)}."),
    x = "K's per 9 (log)", y = "hours per 9"
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Log of strikeouts per nine innings vs game duration</b>. Blue labeled points are influential. Fit line shows evidence of autocorrelation, suggesting there are other factors influencing game times. R-squared is `r comma(r2_K, .01)`. <b>Source</b>: MLB Stats API.</font>

## Pitching {.tabset}

From 1901-1990, each pitching change was associated with about 20 minutes of additional game time. After 1990 the number of pitchers used per game continued to increase while game duration leveled off. After 1990 each pitching change is associated with about 6 minutes of additional game time. 20 minutes per additional pitcher seems high, even if you factor in a mound visit from the pitching coach to buy time for the reliever to warm up. This and the post-1990 divergence suggests there is another factor, something often correlated with the number of pitchers used, but ultimately independent of it.

### Trend

```{r warning=FALSE}
lbl_yr <- c(1901, 2023)
mlb_season_ts %>%
  mutate(
    std_hrs_per_9 = hrs_per_9 / mean(hrs_per_9),
    std_pitchers_per_9 = pitchers_per_9 / mean(pitchers_per_9),
    # std_min_per_pitcher = min_per_pitcher / mean(min_per_pitcher)
  ) %>%
  ggplot(aes(x = season)) +
  geom_area(aes(y = std_hrs_per_9), fill = "gray20", alpha = .10) +
  geom_line(aes(y = std_pitchers_per_9), color = "#003831", linewidth = 1) +
  # # geom_line(aes(y = std_min_per_pitcher), color = "#efb21e", linewidth = 1) +
  geom_point(aes(y = if_else(season %in% lbl_yr, std_pitchers_per_9, NA_real_)),
             color = "#fd5a1e", size = 2) +
  geom_text(aes(x = season + 1,
                y = if_else(season %in% lbl_yr, std_pitchers_per_9 + .1, NA_real_),
                label = comma(pitchers_per_9, .1)),
            family = "Rockwell", size = 3.5, color = "#fd5a1e", hjust = 0) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(breaks = seq(0, 10, 1) / mean(mlb_season_ts$pitchers_per_9), 
                     labels = ~ comma(.x * mean(mlb_season_ts$pitchers_per_9), 1)) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, NA)) +
  # theme(axis.text.y = element_blank()) +
  labs(
    title = "Pitchers per per nine innings",
    subtitle = "against backdrop of average game time.",
    caption = "Source: MLB Stats API.",
    x = NULL, y = NULL
  )
```

### Scatter

```{r}
lm_pitchers <- lm(hrs_per_9 ~ pitchers_per_9, data = mlb_season_ts)
r2_pitchers <- broom::glance(lm_pitchers) %>% pull(adj.r.squared)
mlb_season_ts %>%
  ggplot(aes(x = pitchers_per_9, y = hrs_per_9)) + 
  geom_point() +
  geom_smooth(method = "lm", formula = "y ~ x") +
  labs(
    title = "Strikeouts are correlated with longer game times.",
    subtitle = glue("Adjusted R2 = {comma(glance(lm_pitchers)[1, ]$adj.r.squared, .01)}."),
    x = "Pitchers per 9", y = "hours per 9"
  )
```

### Pitchers + K

```{r}
lm_pK <- lm(hrs_per_9 ~ log(K_per_9) + pitchers_per_9, data = mlb_season_ts)
r2_pK <- broom::glance(lm_pK) %>% pull(adj.r.squared)
lm_pK %>%
  augment() %>%
  ggplot(aes(x = pitchers_per_9, y = hrs_per_9)) + 
  geom_point() +
  geom_line(aes(y = .fitted)) +
  labs(
    title = "Strikeouts are correlated with longer game times.",
    subtitle = glue("Adjusted R2 = {comma(glance(lm_pitchers)[1, ]$adj.r.squared, .01)}."),
    x = "Pitchers per 9", y = "hours per 9"
  )
```

## Stolen Bases

```{r warning=FALSE}
interesting <- c(1987, 2023)
mlb_season_ts %>%
  ggplot(aes(x = season)) +
  geom_area(aes(y = SB_per_9 / (SB_per_9 + CS_per_9) * 4), 
            fill = "gray40", color="gray40", alpha = .05) +
  geom_point(aes(y = SB_per_9 + CS_per_9, color = season %in% interesting), show.legend = FALSE) +
  geom_text(
    data = mlb_season_ts %>% filter(season %in% interesting), 
    aes(y = SB_per_9 + CS_per_9 + .4, 
        label = glue("{comma(SB_per_9 + CS_per_9, .1)}\n{percent(SB_per_9 / (SB_per_9 + CS_per_9), .1)}")),
    size = 3.5, family = "Rockwell Condensed", color = "#fd5a1e"
    ) +
  scale_y_continuous(
    limits = c(0, 4), 
    sec.axis = sec_axis(trans = ~ ./4, labels = percent_format(1), name = "Success Rate")
  ) +
  scale_color_manual(values = c("#003831", "#fd5a1e")) +
  labs(
    title = "Stolen base attempts and success rate up in 2023.",
    subtitle = "Stolen bases per nine innings (points) and success rate (area).",
    x = NULL, y = "Stolen Bases"
  )
```

<font size=-1 color="#666666"><b>Fig. `r (fig_no <- fig_no + 1)`. Stolen base attempts and success rate</b>. Attempts and success rate are up in 2023, but attempts are still well below modern era max in 1987. <b>Source</b>: MLB Stats API.</font>

## Plate Appearances

```{r warning=FALSE}
lbl_yr <- c(1901, 2023)
mlb_season_ts %>%
  mutate(
    std_hrs_per_9 = hrs_per_9 / mean(hrs_per_9),
    std_PA_per_9 = PA_per_9 / mean(PA_per_9),
  ) %>%
  ggplot(aes(x = season)) +
  geom_area(aes(y = std_hrs_per_9), fill = "gray20", alpha = .10) +
  geom_line(aes(y = std_PA_per_9), color = "#003831", linewidth = 1) +
  # # geom_line(aes(y = std_min_per_pitcher), color = "#efb21e", linewidth = 1) +
  geom_point(aes(y = if_else(season %in% lbl_yr, std_PA_per_9, NA_real_)),
             color = "#fd5a1e", size = 2) +
  geom_text(aes(x = season + 1,
                y = if_else(season %in% lbl_yr, std_PA_per_9 + .1, NA_real_),
                label = comma(PA_per_9, .1)),
            family = "Rockwell", size = 3.5, color = "#fd5a1e", hjust = 0) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2.5) / mean(mlb_season_ts$pitchers_per_9), 
                     labels = ~ comma(.x * mean(mlb_season_ts$pitchers_per_9), .1)) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, NA)) +
  # theme(axis.text.y = element_blank()) +
  labs(
    title = "Plate Appearances per per nine innings",
    subtitle = "against backdrop of average game time.",
    caption = "Source: MLB Stats API.",
    x = NULL, y = NULL
  )
```

## Pitches {.tabset}

https://www.baseball-reference.com/bullpen/Pace_of_play
https://sabr.org/journal/article/why-do-games-take-so-long/
https://www.retrosheet.org/gamelogs/glfields.txt

David Smith (2018) concluded a rising pitch count is the predominant driver of game time.^[David W. Smith: "Why Do Games Take So Long?", Baseball Research Journal, SABR, Vol. 47, Nr. 2 (Fall 2018), pp. 64-69. [html](https://sabr.org/journal/article/why-do-games-take-so-long/).] Smith relied on [Retrosheet](https://www.retrosheet.org/) for most of his analysis, but used other data for pitch counts. I used Retrosheet data in [my study on baseball player longevity](https://mpfoley73.github.io/baseball-survival/1_full_analysis.html).

### Trend

```{r warning=FALSE}
lbl_yr <- c(1988, 2023)
mlb_season_ts %>%
  mutate(
    std_hrs_per_9 = hrs_per_9 / mean(hrs_per_9),
    std_P_per_9 = P_per_9 / mean(P_per_9, na.rm = TRUE),
  ) %>%
  ggplot(aes(x = season, y = P_per_9)) +
  geom_area(aes(y = std_hrs_per_9), fill = "gray20", alpha = .10) +
  geom_line(aes(y = std_P_per_9), color = "#003831", linewidth = 1) +
  geom_point(aes(y = if_else(season %in% lbl_yr, std_P_per_9, NA_real_)), 
             color = "#fd5a1e", size = 2) +
  geom_text(aes(x = season + 3, 
                y = if_else(season %in% lbl_yr, std_P_per_9 + .1, NA_real_), 
                label = comma(P_per_9, .1)),
            family = "Rockwell", size = 3.5, color = "#fd5a1e", hjust = 0) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2.5) / mean(mlb_season_ts$P_per_9), 
                     labels = ~ comma(.x * mean(mlb_season_ts$P_per_9), .1)) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, NA)) +
  labs(
    title = "Pitches per nine innings",
    subtitle = "against backdrop of average game time.",
    caption = "Source: MLB Stats API.",
    x = NULL, y = NULL
  )
```

### Scatter 

```{r}
mlb_season_ts %>% filter(season >= 1989) %>% model(TSLM(P_per_9 ~ K_per_9 + trend())) %>% report()
mlb_season_ts %>% filter(season >= 1989) %>% model(TSLM(hrs_per_9 ~ P_per_9)) %>% report()
mlb_season_ts %>%
  filter(season >= 1989) %>%
  ggplot(aes(x = K_per_9, y = P_per_9)) +
  geom_point()
mlb_season_ts %>%
  filter(season >= 1989) %>%
  ggplot(aes(x = P_per_9, y = hrs_per_9)) +
  geom_point()
```


## Pitchers per Game

I'm curious about the dip in game duration between 2000 and 2003. Game duration reached its peak at `r cle_season_ts %>% filter(season == 2000) %>% pull(hours_per_9) %>% pretty_hm()` per game in 2000. Then it underwent a brief period of decline, falling to `r cle_season_ts %>% filter(season == 2003) %>% pull(hours_per_9) %>% pretty_hm()` in 2003. It climbed back to `r cle_season_ts %>% filter(season == 2021) %>% pull(hours_per_9) %>% pretty_hm()` in 2021. I wonder if the reduction in offense after the steroid era is related. Below is the trend of average game times with total runs scored. They both plummeted over that three year period, but they've been moving in opposite directions since 2010. 

```{r}
SF <- 5/3
cle_season_ts %>%
  mutate(P = pitching_G / games) %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), linewidth = 1, color = "#E31937") +
  geom_line(aes(y = P / SF - 0), linewidth = 1, color = "#0C2340") +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4,
    sec.axis = sec_axis(trans = ~ (.x + 0) * SF, labels = comma_format(), name = "Pitchers")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Game times sometimes correlate with number of pitchers.",
       subtitle = "Cleveland average game duration vs Cleveland pitchers.",
       caption = "source: www.baseball-reference.com.") +
   theme(
     axis.text.y.left = element_text(color = "#E31937"),
     axis.text.y.right = element_text(color = "#0C2340", margin = margin(2, 2, 2, 2)),
     axis.title.y.left = element_text(color = "#E31937"),
     axis.title.y.right = element_text(color = "#0C2340", margin = margin(l = 8)),
     plot.caption = element_text(family = "Calibri Light", size = 11),
   )
```

## Correlation Matrix

```{r}
mlb_season_ts %>% 
  select(ends_with("per_9"), -dur_per_9) %>%
  cor()

mlb_season_ts %>% 
  filter(!is.na(P_per_9)) %>%
  select(ends_with("per_9"), -dur_per_9) %>%
  cor()
```

## Benchmark Forecasts

The following sections will use time series analysis to forecast attendance. Some forecasting methods are extremely simple and surprisingly effective. I'll keep them in mind as benchmarks to evaluate the more sophisticated methods. I denote a forecast value with the "hat" notation, $\hat{y}_{T+h|T}$. The subscript $T + h$ means forecasting $h$ periods beyond the observed time series $T$. $\hat{y}_{T+h|T}$ means an $h$ period forecast beyond $T$ based on data through period $T$.

* The **average method** projects the historical average, $\hat{y}_{T+h|T} = \bar{y}.$ 
* The **naive method** projects the last observation, $\hat{y}_{T+h|T} = y_T.$ 
* The **seasonal naive method** projects the last seasonal observation, $\hat{y}_{T+h|T} = y_{T+h-m(k+1)}$. 

The methods can include drift, a straight line from the first and last observation, $\hat{y}_{T+h|T} = y_T + h\left(\frac{y_T - y_1}{T-1}\right).$

```{r warning=FALSE}
cle_season_ts %>%
  # fill_gaps() %>%
  model(Average = MEAN(hours_per_9),
        Naive = NAIVE(hours_per_9),
        RW = RW(hours_per_9 ~ drift())) %>%
  forecast(h = 10) %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = .mean, color = .model)) +
  geom_line(data = cle_season_ts %>% filter(season >= 1911) %>% fill_gaps(), aes(y = hours_per_9)) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(title = "Three benchmark Tribe game duration forecasts.",
       subtitle = "Average, naive, and random walk forecasts, h = 10 seasons.", 
       x = NULL, y = "Hours", color = NULL,
       caption = "source: www.baseball-reference.com.") +
  guides(color = guide_legend(title = "Forecast"))
```

```{r}
saveRDS(cle_season_ts, "../data/cle_season_ts.rds")
saveRDS(mlb_season_ts, "../data/mlb_season_ts.rds")
```

https://www.nyseconomicsassociation.org/wp-content/uploads/2022/06/nyer-sports-2020.pdf#page=24
https://sabr.org/journal/article/why-do-games-take-so-long/
https://github.com/BillPetti/baseballr/blob/master/R/retrosheet_data.R
https://retrosheet.org/Research/SmithD/Relief%20Pitchers%20from%20Exile%20to%20Specialist.pdf
https://fivethirtyeight.com/features/relievers-have-broken-baseball-we-have-a-plan-to-fix-it/
https://www.pitcherlist.com/retrosheet-play-by-play-data-at-your-fingertips/
https://techgraphs.fangraphs.com/tag/retrosheet/


