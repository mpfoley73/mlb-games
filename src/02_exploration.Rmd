---
title: "Cleveland Baseball Game Duration"
subtitle: "Data Exploration"
author: "Michael Foley"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    highlight: tango
    css: "style.css"
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(scales)
library(extrafont)
# library(fpp3)
library(tsibble)
library(fable)
library(patchwork) # for arranging plots
library(glue)
library(png)
library(gridGraphics)
library(grid)

source("00_setup.R")
# loadfonts(device="win")
ball_png <- png::readPNG("../assets/baseball.png", native = TRUE)
ball_grob <- grid::rasterGrob(ball_png, interpolate = FALSE)
```

```{r data}
# Data from step 01.
cle_games <- readRDS("../data/cle_games.rds")
cle_batting <- readRDS("../data/cle_batting.rds")
cle_pitching <- readRDS("../data/cle_pitching.rds")
mlb_pace <- readRDS("../data/mlb_pace.rds")
```

This project investigates the increase in game duration and the effect of recent efforts to quicken the pace. Games today last nearly twice as long as they did in 1901. Baseball-Reference has a rich source of game features that might help explain trends in game time. The Baseball-Reference section for the [Cleveland Guardians](https://www.baseball-reference.com/teams/CLE/2023.shtml) lists game-by-game results since their first season in 1901. [Step 01](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/src/01_get_games.R) aggregated `r n_distinct(cle_games$season)` seasons of game summaries, including YTD for 2023, into `cle_games`, a `r comma(nrow(cle_games))` x `r ncol(cle_games)` data frame with one row per game. Step 01 also downloaded player season summaries for hitters (`cle_batting`, `r comma(nrow(cle_batting))` x `r ncol(cle_batting)`) and pitchers (`cle_pitching`, `r comma(nrow(cle_pitching))` x `r ncol(cle_pitching)`). The MLB stats API provides more detailed statistics. However, it proved difficult to get just the Cleveland game stats, so I pulled MLB-wide seasonal summaries (one record per season) instead. Here in step 02, I prepare the data for further analysis by creating time-series tsibbles. Along the way I explore the variable relationships with game duration, and engineer useful data transformations. Main outputs:

- Summarize the annual Cleveland player summaries of batting and pitching into annual _team-wide_ summaries.
- Standardize Cleveland variables into per-nine-innings.
- Save to object `cle_season_ts` in the data folder.

# The Data Sets {.tabset .tabset-fade .tabset-pills}

The [game-by-game summaries](https://www.baseball-reference.com/teams/CLE/2023-schedule-scores.shtml), and [pitching and batting summaries](https://www.baseball-reference.com/teams/CLE/2023.shtml) produced in [Step 01 - BREF](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/src/01_get_bref_data.R) are from Baseball Reference. The web pages are useful for variable definitions. The MLB summaries produced in [Step 01 - MLB](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/src/01_get_mlb_data.R) are from the MLB stats API. The data files are summarized in the following tabs. Potentially interesting game duration predictors include:

- `cle_games`: `game_date` (time of year), `day_ind` (day or night game), `doubleheader_game` (0 (not a double-header), 1, and 2), `runs_scored` + `runs_allowed`, and `innings`.

- `cle_batting`: `PA` (plate appearances), `BB` and `SO` (don't have number of pitches, but walks and strikeouts probably take more pitches). Somewhat off subject, but `SB` and `CS` are related to the 2023 rule change that increased the base size. Also, eliminating the shift in 2023 might increase batting average, `BA`, and reduce the incentive to hit home runs, `BA`.

- `cle_pitching`: `G` (sum to number of pitchers used in games), `BB` and `SO` (the defensive side of this effect).

## Games

```{r}
skimr::skim(cle_games)
```

## Batting

```{r}
skimr::skim(cle_batting)
```

## Pitching

```{r}
skimr::skim(cle_pitching)
```

## MLB

```{r}
skimr::skim(mlb_pace %>% select(-time_per_P))
summary(mlb_pace$time_per_P)
```

# Combine and Standardize

This section summarizes the three Cleveland data sets into seasonal summaries and combines into a single data set. Most variables are related to the number of innings played, so this section standardizes the data per nine innings. I will use the **tsibble** package for time series analysis.

```{r echo=TRUE}
# key includes doubleheader game in order to index by game.
cle_games_ts <- cle_games %>%
  mutate(
    game_hours = as.duration(game_duration) / dhours(1),
    hours_per_9 = game_hours / innings * 9,
    game_runs = runs_scored + runs_allowed,
    runs_per_9 = game_runs / innings * 9
  ) %>% 
  relocate(any_of(c("game_runs", "runs_per_9")), .after = 15) %>%
  relocate(any_of(c("game_hours", "hours_per_9")), .after = 22) %>%
  tsibble(key = c(doubleheader_game), index = game_date)

cle_batting_ts <- cle_batting %>%
  # Singles are used in SLG calc.
  mutate(`1B` = H - (`2B` + `3B` + HR)) %>%
  relocate(`1B`, .before = 10) %>%
  summarize(.by = season, across(c(PA:SO, TB:IBB), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    BA = H / AB,
    OBP = (H + BB + HBP) / (AB + BB + HBP + SF),
    SLG = (`1B` + 2*`2B` + 3*`3B` + 4*HR) / AB,
    OPS = OBP + SLG
  ) %>%
  rename_with(~ paste0("batting_", .x), c(PA:OPS)) %>%
  tsibble(index = season)

cle_pitching_ts <- cle_pitching %>%
  summarize(.by = season, across(c(G:BF), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    ERA = 9 * ER / IP,
    WHIP = (BB + H) / IP,
    H_per_9 = 9 * H / IP,
    HR_per_9 = 9 * HR / IP,
    BB_per_9 = 9 * BB / IP,
    SO_per_9 = 9 * SO / IP
  ) %>%
  select(-c(GS, GF, SV)) %>%
  rename_with(~ paste0("pitching_", .x), c(G:SO_per_9)) %>%
  tsibble(index = season)
```

`cle_games_ts` is at the game granularity. Summarize it to the season level and combine with the batting and pitching season summaries to create a singe tsibble.

```{r echo=TRUE}
summarize_games <- function(dat) {
  dat %>% summarize(
    avg_hours = mean(game_hours, na.rm = TRUE),
    hours_per_9 = mean(hours_per_9, na.rm = TRUE),
    avg_home_attendance = mean(if_else(home_ind == "Home", attendance, NA_real_), na.rm = TRUE),
    wins = sum(str_sub(outcome, 1, 1) == "W"),
    losses = sum(str_sub(outcome, 1, 1) == "L"),
    avg_runs_per_9 = mean(runs_per_9),
    innings = sum(innings),
    place = last(new_rank),
    games = n(),
    home_games = sum(home_ind == "Home"),
    away_games = sum(home_ind == "Away")
  )
}

cle_season_ts <- cle_games_ts %>%
  arrange(season, game_no) %>% #filter(season == 2020)
  index_by(season = ~ year(.)) %>%
  summarize_games() %>%
  mutate(winning_pct = wins / (wins + losses)) %>%
  relocate(c(winning_pct, place), .after = 6) %>%
  inner_join(cle_batting_ts, join_by(season)) %>%
  mutate(
    batting_PA_per_9 = batting_PA / innings * 9,
    batting_SB_per_9 = batting_SB / innings * 9,
    batting_CS_per_9 = batting_CS / innings * 9,
    batting_H_per_9 = batting_H / innings * 9,
    batting_HR_per_9 = batting_HR / innings * 9,
    batting_BB_per_9 = batting_BB / innings * 9,
    batting_SO_per_9 = batting_SO / innings * 9
  ) %>%
  inner_join(cle_pitching_ts, join_by(season))
```

The MLB data is already at the seasonal granularity. Define it as a tsibble.

```{r}
mlb_season_ts <- tsibble(mlb_pace, index = season) %>%
  mutate(
    hours_per_9 = as.duration(time_per_9) / dhours(1),
    seconds_per_PA = as.duration(time_per_PA) / dseconds(1),
    seconds_per_P = as.duration(time_per_P) / dseconds(1),
  )
```

# Data Coverage {.tabset .tabset-fade .tabset-pills}

Almost all features are fully populated. Attendance is somewhat spotty before 1930. Double-header games record attendance for only one of the games. Game duration is spotty before 1940.

```{r}
p1 <- cle_games_ts %>%
  filter(doubleheader_game == 0) %>%
  index_by(season = ~ year(.)) %>%
  summarize(na_attendance = sum(if_else(is.na(attendance), 1, 0))) %>%
  ggplot(aes(x = season, y = na_attendance)) + 
  geom_col(width = 1.0, fill = "#E31937", alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  annotate(
    geom = "curve", x = 2012, y = 57, xend = 2017, yend = 47, 
    curvature = .10, arrow = arrow(length = unit(2, "mm")),
    color = "#0C2340"
  ) +
  annotate(
    geom = "text", x = 2007, y = 68, label = "COVID", size = 3.5, 
    family = "Rockwell Condensed", hjust = "left", color = "#0C2340") +
  coord_cartesian(ylim = c(0, 150)) +
  theme(axis.text.x = element_blank()) +
  labs(
    subtitle = "Games with no recorded attendance.",
    x = NULL, y = NULL, fill = "Doublehader Game"
  )

p2 <- cle_games_ts %>%
  index_by(season = ~ year(.)) %>%
  group_by(season) %>%
  summarize(na_duration = sum(if_else(is.na(game_duration), 1, 0))) %>%
  ggplot(aes(x = season, y = na_duration)) + 
  geom_col(width = 1.0, fill = "#E31937", alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  # theme_light() +
  # theme_mlb +
  labs(
    subtitle = "Games with no recorded duration.",
    x = NULL, y = NULL
  )

p1 / p2 + plot_annotation(
  title = "Attendance and duration data is spotty prior to 1940",
  caption = str_wrap("Attendance for game two of a double header is recorded as zero. Plot excludes game two. \nSource: www.baseball-reference.com.", 120)
)
```

## cle_games_ts

```{r}
cle_games_ts %>% as_tibble() %>% skimr::skim()
```

## cle_season_ts

```{r}
cle_season_ts %>% as_tibble() %>% skimr::skim()
```

# Feature Exploration

These subsections take a closer look at the features in the data set. The main purpose is characterize the relationships with the `hours_per_9` outcome variable, and possibly reduce the field of explanatory variables. Some variables, like `avg_home_attendance`, are not useful toward understanding game duration, but are worth a look just because they are interesting.

## Attendance

Attendance data is spotty prior to 1940, so perhaps we should take the season averages with a grain of salt for those years. Also, attendance is constrained by the park capacity. Attendance might have been higher, at least in the 1990s when Cleveland sold out 455 straight games from 6/12/1995 through 4/2/2001. Here is a brief look at capacity:

- [League Park](https://en.wikipedia.org/wiki/League_Park) was built in 1891 and seated 9,000. The Spiders played their until folding after the 1899 season. The Indians (originally the Blues) started in 1901. In 1910 the park was rebuilt with concrete and steel with 18,000 seats.
- Municipal Stadium opened in 1932. The Indians played there from July 1932 through 1933, but returned to League Park in 1934 because attendance didn't justify such a large facility. Beginning in 1937, the Indians played weekend and holiday games at Municipal stadium and gradually added more dates. Beginning in 1947 all games were played there.
- [Progressive Field](https://en.wikipedia.org/wiki/Progressive_Field) (named Jacobs Field from 1994-2007) opened in 1994 with a capacity of 42,865. Modifications increased capacity to 45,199 in 2009. Other modifications in 2011 reduced to 43,441, then 36,856 in 2015, and 34,830 in 2021.

Attendance is generally correlated with winning, but something seems wrong with the two World Series years, 1948 and 1954. Average attendance in 1947, the first full season at Municipal Stadium, was 25,300. The Tribe finished 80-74 that year. The next season the Tribe went 97-58 and went on to win the World Series. Average attendance swelled to 40,300. Despite finishing 89-65 in 1949, attendance fell to 36,300, then to 26,700 in 1950. It continued to fall each season, reaching a low of 16,800 in 1953, despite 90+ wins each year. The 1954 season, with the gaudy 111-43 record only lifted attendance to 20,000 per game. It resumed its decline the next season. It briefly rebounded to 23,800 in 1959, but would not exceed 20,000 again until 1993.

```{r}
SF <- 50000
(step_2_fig1 <- cle_season_ts %>%
  mutate(attend = if_else(season == 2020, 0, avg_home_attendance)) %>%
  ggplot(aes(x = season, y = attend)) +
  geom_col(aes(y = 1 * SF), fill = "#0C2340", width = 1, alpha = 0.2) +
  geom_col(aes(y = wins / (wins + losses) * SF), fill = "#0C2340", width = 1, alpha = 0.2) +
  geom_line(color = "#E31937", na.rm = TRUE, linewidth = 1) +
  geom_point(aes(y = if_else(season %in% c(1920, 1948, 1954, 1995, 1997, 2016), attend, NA_real_)),
             shape = 21, color = "#E31937", fill = "white", size = 3, na.rm = TRUE) +
  geom_hline(yintercept = 0.50 * SF, linetype = 3, linewidth = 1, color = "#0C2340") +
  annotate(
    geom = "curve", x = 1960, y = 28000, xend = 1954, yend = 22000, 
    curvature = .3, arrow = arrow(length = unit(2, "mm")),
    color = "#0C2340"
  ) +
  annotate("text", x = 1960, y = 28000, label = "where is everyone?", size = 3, 
           hjust = "left", color = "#0C2340") +
  scale_y_continuous(limits = c(0, NA), 
                     labels = scales::comma,
                     expand = c(0,0),
                     sec.axis = sec_axis(trans = ~ .x / SF,
                                         labels = scales::percent_format(),
                                         name = "Winning Percentage")) +
  scale_x_continuous(breaks = seq(1900, 2030, 10), expand = c(0,0)) +
  labs(x = NULL, y = "Fans per Game",
       title = "Fans love a winner... usually.",
       subtitle = "Annual attendance averages and Cleveland's winning percentage.",
       caption = "source: www.baseball-reference.com.") +
  theme(
    axis.text.y.left = element_text(color = "#E31937"),
    axis.title.y.left = element_text(color = "#E31937", margin = margin(r = 5)),
    axis.title.y.right = element_text(color = "#0C2340", margin = margin(l = 5))
  )
)
```

As an aside, check out 1917 and 1918. Game attendance does not seem unusual those two years despite WWI and the influenza pandemic. The US entered WWI in Apr '17 and the war ended after the season concluded in '18. The 1918 influenza pandemic started in the spring, but seems to have really taken off around October. Baseball survived the war as an acceptable diversion from civic duty, and in fact patriotic elements were integrated into the games.

## Game Duration {.tabset}

```{r}
max_avg <- mlb_season_ts %>% slice_max(order_by = hours_per_9)
avg_2023 <- mlb_season_ts %>% filter(season == 2023)
```

Games typically lasted around two hours up to 1945. Then over the course of ten seasons game times increased to 2.5 hours. In the late 1970s games began increasing again, peaking at `r max_avg %>% pull(hours_per_9) %>% pretty_hm(verbose = TRUE)` in `r max_avg %>% pull(season)`. Significant changes in 2023 appear to have halted the advance. Average game times in 2023 have been `r avg_2023 %>% pull(hours_per_9) %>% pretty_hm(verbose = TRUE)` year to date.

Average game duration does not appear to change much within seasons. It falls about .2 hours (12 minutes) over the course of the season. The apparent increase in March game times is an artifact of March games not occurring until 1998. 

### By Year

```{r}
knot_yrs <- c(1944, 1955, 1978, 2021, 2023)

model(mlb_season_ts, TSLM(hours_per_9 ~ trend(knots = knot_yrs))) %>%
  augment() %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), color = "#003831", linewidth = 1) +
  geom_line(aes(y = .fitted), color = "#fd5a1e", linetype = 2, linewidth = .5) +
  geom_text(data = mlb_season_ts %>% filter(season %in% knot_yrs), 
            aes(y = hours_per_9 + if_else(season < 1980, -.15, +.15), label = pretty_hm(hours_per_9)), 
            family = "Rockwell", size = 3.5, color = "#003831", hjust = 0) + 
  geom_point(data = mlb_season_ts %>% filter(season %in% knot_yrs), 
             aes(y = hours_per_9),
             color = "#fd5a1e", size = 2) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 8, labels = pretty_hm) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(
    title = "Pace of play returning to historic rates",
    subtitle = "Average time per nine innings of play.",
    caption = "Source: MLB Sats API.",
    x = NULL, y = NULL
  )
```

### CLE

```{r}
model(cle_season_ts, TSLM(hours_per_9 ~ trend(knots = knot_yrs))) %>%
  augment() %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), color = "#0C2340", linewidth = 1) +
  geom_line(aes(y = .fitted), color = "#E31937", linetype = 2, linewidth = .5) +
  geom_text(data = cle_season_ts %>% filter(season %in% knot_yrs), 
            aes(y = hours_per_9 + if_else(season < 1980, -.15, +.15), label = pretty_hm(hours_per_9)), 
            family = "Rockwell", size = 3.5, color = "#0C2340", hjust = 0) + 
  geom_point(data = cle_season_ts %>% filter(season %in% knot_yrs), 
             aes(y = hours_per_9),
             color = "#E31937", size = 2) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 8, labels = pretty_hm) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(
    title = "Pace of play returning to historic rates",
    subtitle = "Cleveland baseball average time per nine innings of play.",
    caption = "Source: www.baseball-reference.com.",
    x = NULL, y = NULL
  )
```

### By Month in Year

```{r warning=FALSE}
cle_tsibble_yrmo <- cle_games_ts %>%
  index_by(yrmo = ~ yearmonth(.)) %>%
  summarize_games()

cle_tsibble_mmm <- cle_games_ts %>%
  index_by(mmm = ~ month(.)) %>%
  summarize_games() %>%
  mutate(mmm = ym(paste0("9999-", mmm)))

ggplot() +
  geom_line(data = cle_tsibble_yrmo,
            aes(x = month(yrmo, label = TRUE, abbr = TRUE), y = hours_per_9,
                group = factor(year(yrmo)), color = year(yrmo)),
            show.legend = TRUE, alpha = 0.2) +
  scale_color_gradient(low = "#0C2340", high = "#E31937") +
  geom_line(data = cle_tsibble_mmm,
            aes(x = month(mmm, label = TRUE, abbr = TRUE), y = hours_per_9,
                group = factor(year(mmm))), 
            alpha = 0.8) +
  scale_y_continuous(limits = c(0, NA), labels = pretty_hm) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.25)) +
  labs(title = "Game duration falls slightly within a season.",
       subtitle = "Average game duration by month of season. Bold line is average.", 
       x = NULL, y = NULL, color = NULL,
       caption = "source: www.baseball-reference.com.")
```

## Doubleheaders {.tabset}

```{r}
double_header <- cle_games_ts %>%
  mutate(doubleheader_ind = if_else(doubleheader_game == 0, "Single Game", "Doubleheader")) %>%
  index_by(season = ~ year(.)) %>%
  group_by(season, doubleheader_ind) %>%
  summarize(hours_per_9 = mean(hours_per_9, na.rm = TRUE), n = n())

double_header_effect <- double_header %>%
  as_tibble() %>%
  pivot_wider(id_cols = season, names_from = doubleheader_ind, values_from = hours_per_9) %>%
  mutate(twin_diff = `Doubleheader` - `Single Game`)
```

Prior to 1942, a few doubleheaders would be scheduled each season. There doesn't appear to be a pattern: it might be on a Tuesday, for instance. Sunday doubleheaders became common in 1942, either scheduled or as make-ups. In 1943, most Sundays were scheduled doubleheaders and over 50% of baseball games overall were part of a doubleheader. Scheduled doubleheaders, esp. Sundays, were common through 1978. After that, only two or three might be scheduled.

Doubleheaders have become less common while game times have increased. Is there a negative correlation, perhaps a compensating effect? The answer is no, doubleheaders are irrelevant. The average doubleheader game is shorter by only `r scales::comma(mean(double_header_effect$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)` minutes.

```{r}
SF <- 50 # scaling factor for sec.axis.
double_header %>%
  ggplot(aes(x = season)) +
  geom_col(aes(y = n / SF, fill = fct_rev(doubleheader_ind)), alpha = 0.2, width = 1.0) +
  geom_line(aes(y = hours_per_9, color = fct_rev(doubleheader_ind)), linewidth = 1) +
  scale_color_manual(values = as.character(pal_cle)) +
  scale_fill_manual(values = as.character(pal_cle)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4,
    sec.axis = sec_axis(trans = ~ .x * SF, labels = comma_format(), name = "Games Played")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Players don't rush through doubleheaders.",
       subtitle = glue("Doubleheader games are shorter by only {scales::comma(mean(double_header_effect$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)} minutes on average."),
       caption = "source: www.baseball-reference.com.") +
  theme(
    legend.position = "top",
    axis.title.y.right = element_text(margin = margin(l = 5))
  )
```

## Night Games

```{r}
day_night <- cle_games_ts %>%
  index_by(season = ~ year(.)) %>%
  group_by(season, day_ind) %>%
  summarize(hours_per_9 = mean(hours_per_9, na.rm = TRUE), n = n())
```

Until the late 1930s, all games were played in the afternoon. By the mid 1970s day games were primarily on weekends. While there might be a different dynamic to paying in the afternoon (*it's hot - let's get out of here!*), the data doesn't bear that out. The advent of night games is not associated with longer games.

```{r}
SF <- 50 # scaling factor for sec.axis.
day_night %>%
  ggplot(aes(x = season)) +
  geom_col(aes(y = n / SF, fill = day_ind), alpha = 0.2, width = 1.0) +
  geom_line(aes(y = hours_per_9, color = day_ind), linewidth = 1) +
  scale_color_manual(values = as.character(pal_cle)) +
  scale_fill_manual(values = as.character(pal_cle)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4,
    sec.axis = sec_axis(trans = ~ .x * SF, labels = comma_format(), name = "Games Played")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Night games are more common, but they're not longer.",
       subtitle = "Cleveland Indians average game duration, with periods of growth and stability.",
       caption = "source: www.baseball-reference.com.") +
  theme(
    legend.position = "top",
    axis.title.y.right = element_text(margin = margin(l = 5))
  )
```

## Runs

I'm curious about the dip in game duration between 2000 and 2003. Game duration reached its peak at `r cle_season_ts %>% filter(season == 2000) %>% pull(hours_per_9) %>% pretty_hm()` per game in 2000. Then it underwent a brief period of decline, falling to `r cle_season_ts %>% filter(season == 2003) %>% pull(hours_per_9) %>% pretty_hm()` in 2003. It climbed back to `r cle_season_ts %>% filter(season == 2021) %>% pull(hours_per_9) %>% pretty_hm()` in 2021. I wonder if the reduction in offense after the steroid era is related. Below is the trend of average game times with total runs scored. They both plummeted over that three year period, but they've been moving in opposite directions since 2010. 

```{r}
SF <- 5 # scaling factor for sec.axis.
cle_season_ts %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), linewidth = 1, color = "#E31937") +
  geom_col(aes(y = avg_runs_per_9 / SF), width = 1.0, fill = "#0C2340", alpha = 0.2) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4,
    sec.axis = sec_axis(trans = ~ .x * SF, labels = comma_format(), name = "Runs")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Game times fell after the steroid era.",
       subtitle = "Cleveland average game duration vs runs scored.",
       caption = "source: www.baseball-reference.com.") +
   theme(
     axis.text.y.left = element_text(color = "#E31937"),
     axis.title.y.left = element_text(color = "#E31937"),
     axis.title.y.right = element_text(color = "#0C2340", margin = margin(l = 5)),
     plot.caption = element_text(family = "Calibri Light", size = 11)
   )
```

Incidentally, compare the offense in the 1930s to the steroid era of the 1990s. And there's that year of the pitcher, 1968. But then 1972 does not look so hot. It should be noted that these are just Cleveland games. There may be seasons when the Tribe/Guards had decent pitching, but no hitting, or vice-versa (or, sadly, neither).

## Plate Appearances

I'm curious about the dip in game duration between 2000 and 2003. Game duration reached its peak at `r cle_season_ts %>% filter(season == 2000) %>% pull(hours_per_9) %>% pretty_hm()` per game in 2000. Then it underwent a brief period of decline, falling to `r cle_season_ts %>% filter(season == 2003) %>% pull(hours_per_9) %>% pretty_hm()` in 2003. It climbed back to `r cle_season_ts %>% filter(season == 2021) %>% pull(hours_per_9) %>% pretty_hm()` in 2021. I wonder if the reduction in offense after the steroid era is related. Below is the trend of average game times with total runs scored. They both plummeted over that three year period, but they've been moving in opposite directions since 2010. 

```{r}
SF <- 10
cle_season_ts %>%
  mutate(PA = batting_PA_per_9 + pitching_BF / innings * 9) %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), linewidth = 1, color = "#E31937") +
  geom_line(aes(y = PA / SF - 5), linewidth = 1, color = "#0C2340") +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4,
    sec.axis = sec_axis(trans = ~ (.x + 5) * SF, labels = comma_format(), name = "Plate Appearances")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Game times sometimes correlate with plate appearances.",
       subtitle = "Cleveland average game duration vs plate appearances.",
       caption = "source: www.baseball-reference.com.") +
   theme(
     axis.text.y.left = element_text(color = "#E31937"),
     axis.text.y.right = element_text(color = "#0C2340", margin = margin(2, 2, 2, 2)),
     axis.title.y.left = element_text(color = "#E31937"),
     axis.title.y.right = element_text(color = "#0C2340", margin = margin(l = 8)),
     plot.caption = element_text(family = "Calibri Light", size = 11),
   )
```

## Pitchers per Game

I'm curious about the dip in game duration between 2000 and 2003. Game duration reached its peak at `r cle_season_ts %>% filter(season == 2000) %>% pull(hours_per_9) %>% pretty_hm()` per game in 2000. Then it underwent a brief period of decline, falling to `r cle_season_ts %>% filter(season == 2003) %>% pull(hours_per_9) %>% pretty_hm()` in 2003. It climbed back to `r cle_season_ts %>% filter(season == 2021) %>% pull(hours_per_9) %>% pretty_hm()` in 2021. I wonder if the reduction in offense after the steroid era is related. Below is the trend of average game times with total runs scored. They both plummeted over that three year period, but they've been moving in opposite directions since 2010. 

```{r}
SF <- 5/3
cle_season_ts %>%
  mutate(P = pitching_G / games) %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = hours_per_9), linewidth = 1, color = "#E31937") +
  geom_line(aes(y = P / SF - 0), linewidth = 1, color = "#0C2340") +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_y_continuous(limits = c(0, NA), n.breaks = 4,
    sec.axis = sec_axis(trans = ~ (.x + 0) * SF, labels = comma_format(), name = "Pitchers")
  ) +
  coord_cartesian(xlim = c(1900, 2030), ylim = c(0, 3.5)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Game times sometimes correlate with number of pitchers.",
       subtitle = "Cleveland average game duration vs Cleveland pitchers.",
       caption = "source: www.baseball-reference.com.") +
   theme(
     axis.text.y.left = element_text(color = "#E31937"),
     axis.text.y.right = element_text(color = "#0C2340", margin = margin(2, 2, 2, 2)),
     axis.title.y.left = element_text(color = "#E31937"),
     axis.title.y.right = element_text(color = "#0C2340", margin = margin(l = 8)),
     plot.caption = element_text(family = "Calibri Light", size = 11),
   )
```

## Benchmark Forecasts

The following sections will use time series analysis to forecast attendance. Some forecasting methods are extremely simple and surprisingly effective. I'll keep them in mind as benchmarks to evaluate the more sophisticated methods. I denote a forecast value with the "hat" notation, $\hat{y}_{T+h|T}$. The subscript $T + h$ means forecasting $h$ periods beyond the observed time series $T$. $\hat{y}_{T+h|T}$ means an $h$ period forecast beyond $T$ based on data through period $T$.

* The **average method** projects the historical average, $\hat{y}_{T+h|T} = \bar{y}.$ 
* The **naive method** projects the last observation, $\hat{y}_{T+h|T} = y_T.$ 
* The **seasonal naive method** projects the last seasonal observation, $\hat{y}_{T+h|T} = y_{T+h-m(k+1)}$. 

The methods can include drift, a straight line from the first and last observation, $\hat{y}_{T+h|T} = y_T + h\left(\frac{y_T - y_1}{T-1}\right).$

```{r warning=FALSE}
cle_season_ts %>%
  # fill_gaps() %>%
  model(Average = MEAN(hours_per_9),
        Naive = NAIVE(hours_per_9),
        RW = RW(hours_per_9 ~ drift())) %>%
  forecast(h = 10) %>%
  ggplot(aes(x = season)) +
  geom_line(aes(y = .mean, color = .model)) +
  geom_line(data = cle_season_ts %>% filter(season >= 1911) %>% fill_gaps(), aes(y = hours_per_9)) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(title = "Three benchmark Tribe game duration forecasts.",
       subtitle = "Average, naive, and random walk forecasts, h = 10 seasons.", 
       x = NULL, y = "Hours", color = NULL,
       caption = "source: www.baseball-reference.com.") +
  guides(color = guide_legend(title = "Forecast"))
```

```{r}
saveRDS(cle_season_ts, "../data/cle_season_ts.rds")
```

https://www.nyseconomicsassociation.org/wp-content/uploads/2022/06/nyer-sports-2020.pdf#page=24
