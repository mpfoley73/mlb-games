---
title: "Cleveland Baseball Game Duration"
subtitle: "Data Exploration"
author: "Michael Foley"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    highlight: tango
    css: "style.css"
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(scales)
library(extrafont)
# library(fpp3)
library(tsibble)
library(fable)
library(patchwork) # for arranging plots
library(glue)
library(png)
library(gridGraphics)
library(grid)

source("00_setup.R")
ball_png <- png::readPNG("../assets/baseball.png", native = TRUE)
ball_grob <- grid::rasterGrob(ball_png, interpolate = FALSE)
```

```{r data}
# Data from step 01.
cle_games <- readRDS("../data/cle_games.rds")
cle_batting <- readRDS("../data/cle_batting.rds")
cle_pitching <- readRDS("../data/cle_pitching.rds")
```

This project investigates the increase in game duration and the effect of recent efforts to quicken the pace. Games today last nearly twice as long as they did in 1901. Baseball-Reference has a rich source of game features that might help explain trends in game time. The Baseball-Reference section for the [Cleveland Guardians](https://www.baseball-reference.com/teams/CLE/2023.shtml) lists game-by-game results since their first season in 1901. [Step 01](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/src/01_get_games.R) aggregated `r n_distinct(cle_games$season)` seasons of game summaries, including YTD for 2023, into `cle_games`, a `r comma(nrow(cle_games))` x `r ncol(cle_games)` data frame with one row per game. Step 01 also downloaded player season summaries for hitters (`cle_batting`, `r comma(nrow(cle_batting))` x `r ncol(cle_batting)`) and pitchers (`cle_pitching`, `r comma(nrow(cle_pitching))` x `r ncol(cle_pitching)`). This step explores the variable relationships with game duration, and engineers useful data transformations along the way. Main outputs:

- Summarize the annual player summaries of batting and pitching into annual _team-wide_ summaries.
- Standardize variables into per-nine-innings.
- Save to object `cle_tsibble_yr` in the data folder.

# The Data Sets {.tabset .tabset-fade .tabset-pills}

[Game-by-game summaries](https://www.baseball-reference.com/teams/CLE/2023-schedule-scores.shtml), and [pitching and batting summaries](https://www.baseball-reference.com/teams/CLE/2023.shtml) are from Baseball Reference. The linked web pages have useful variable definitions. Potentially interesting game duration predictors:

- `cle_games`: `game_date` (time of year), `day_ind` (day or night game), `doubleheader_game` (0 (not a double-header), 1, and 2), `runs_scored` + `runs_allowed`, and `innings`.

- `cle_batting`: `PA` (plate appearances), `BB` and `SO` (don't have number of pitches, but walks and strikeouts probably take more pitches). Somewhat off subject, but `SB` and `CS` are related to the 2023 rule change that increased the base size. Also, eliminating the shift in 2023 might increase batting average, `BA`, and reduce the incentive to hit home runs, `BA`.

- `cle_pitching`: `G` (sum to number of pitchers used in games), `BB` and `SO` (the defensive side of this effect).

## Games

```{r}
skimr::skim(cle_games)
```

## Batting

```{r}
skimr::skim(cle_batting)
```

## Pitching

```{r}
skimr::skim(cle_pitching)
```

# Combine and Standardize

This section summarizes the three data sets into seasonal summaries and combines into a single data set. Most variables are related to the number of innings played, so this section standardizes the data per nine innings. I will use the **tsibble** package for time series analysis.

```{r echo=TRUE}
# key includes doubleheader game in order to index by game.
cle_games_ts <- cle_games %>%
  mutate(
    hrs = as.duration(game_duration) / dhours(1),
    hrs_per_9 = hrs / innings * 9,
    runs = runs_scored + runs_allowed,
    runs_per_9 = runs / innings * 9
  ) %>% 
  tsibble(key = c(doubleheader_game), index = game_date)

cle_batting_ts <- cle_batting %>%
  # Singles are used in SLG calc.
  mutate(`1B` = H - (`2B` + `3B` + HR)) %>%
  rename(yr = season) %>%
  summarize(.by = yr, across(c(PA:SO, TB:`1B`), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    BA = H / AB,
    OBP = (H + BB + HBP) / (AB + BB + HBP + SF),
    SLG = (`1B` + 2*`2B` + 3*`3B` + 4*HR) / AB,
    OPS = OBP + SLG
  ) %>%
  rename_with(~ paste0("batting_", .x), c(PA:OPS)) %>%
  tsibble(index = yr)

cle_pitching_ts <- cle_pitching %>%
  rename(yr = season) %>%
  summarize(.by = yr, across(c(CG:BF), ~sum(.x, na.rm = TRUE))) %>%
  mutate(
    ERA = 9 * ER / IP,
    WHIP = (BB + H) / IP,
    H9 = 9 * H / IP,
    HR9 = 9 * HR / IP,
    BB9 = 9 * BB / IP,
    SO9 = 9 * SO / IP,
    `SO_per_BB` = SO / BB
  ) %>%
  select(-c(IP)) %>%
  rename_with(~ paste0("pitching_", .x), c(CG:SO_per_BB)) %>%
  tsibble(index = yr)
```

`cle_games_ts` is at the game granularity. Summarize it to the season level.

```{r echo=TRUE}
summarize_games <- function(dat) {
  dat %>% summarize(
    mean_hrs = mean(hrs, na.rm = TRUE),
    mean_hrs_per_9 = mean(hrs_per_9, na.rm = TRUE),
    mean_home_att = mean(if_else(home_ind == "Home", attendance, NA_real_), na.rm = TRUE),
    wins = sum(str_sub(outcome, 1, 1) == "W"),
    losses = sum(str_sub(outcome, 1, 1) == "L"),
    runs_per_9 = mean(runs_per_9),
    innings = sum(innings)
  )
}

cle_season_ts <- cle_games_ts %>%
  index_by(yr = ~ year(.)) %>%
  summarize_games() %>%
  inner_join(cle_batting_ts, join_by(yr)) %>%
  inner_join(cle_pitching_ts, join_by(yr)) %>%
  mutate(
    winning_pct = wins / (wins + losses),
    batting_PA_per_9 = batting_PA / innings * 9,
    
  )

# Standardize games to a 9-inning game
cle_games_per9 <- cle_games %>%
  mutate(
    ,
    
  )


```


# Tsibbles

 To get an accurate measure of pace of play, I will standardize variables to per-nine-innings.

```{r echo=TRUE}
# Summarize annual, monthly
summarize_games <- function(dat) {
  dat %>% summarize(
    game_hrs9 = mean(game_hrs9, na.rm = TRUE),
    home_att = mean(if_else(home_ind == "Home", attendance, NA_real_), na.rm = TRUE),
    wins = sum(str_sub(outcome, 1, 1) == "W"),
    losses = sum(str_sub(outcome, 1, 1) == "L"),
    runs9 = mean(runs9)
  )
}

# Annual summary
cle_tsibble_yr <- cle_tsibble %>%
  index_by(yr = ~ year(.)) %>%
  summarize_games() %>%
  inner_join(cle_batting_tsibble_yr, join_by(yr)) %>%
  inner_join(cle_pitching_tsibble_yr, join_by(yr)) %>%
  mutate(
    winning_pct = wins / (wins + losses)
  )

# Monthly summary. Not sure how best to deal with missing values (Nov - Mar).
cle_tsibble_yrmo <- cle_tsibble %>%
  index_by(yrmo = ~ yearmonth(.)) %>%
  summarize_games()

cle_tsibble_mmm <- cle_tsibble %>%
  index_by(mmm = ~ month(.)) %>%
  summarize_games() %>%
  mutate(mmm = ym(paste0("9999-", mmm)))
```

## Feature Exploration

Most features are fully populated. The `attendance` data is somewhat spotty, primarily in the early years (and also in double-header games because attendance is only recorded for one game of a doubleheader). `game_duration` is also spotty in the early years.

```{r}
p1 <- cle_tsibble %>%
  filter(doubleheader_game == 0) %>%
  index_by(yr = ~ year(.)) %>%
  # group_by(yr, doubleheader_game) %>%
  summarize(na_attendance = sum(if_else(is.na(attendance), 1, 0))) %>%
  ggplot(aes(x = yr, y = na_attendance)) + 
  geom_col(width = 1.0, fill = cle_colors["red"], alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  annotate(
    geom = "curve", x = 2012, y = 57, xend = 2017, yend = 47, 
    curvature = .10, arrow = arrow(length = unit(2, "mm")),
    color = cle_colors["navy_blue"]
  ) +
  annotate(
    geom = "text", x = 2007, y = 68, label = "COVID", size = 3.5, 
    family = "Rockwell Condensed", hjust = "left", color = cle_colors["navy_blue"]) +
  coord_cartesian(ylim = c(0, 150)) +
  theme(axis.text.x = element_blank()) +
  labs(
    subtitle = "Games with no recorded attendance.",
    x = NULL, y = NULL, fill = "Doublehader Game"
  )

p2 <- cle_tsibble %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr) %>%
  summarize(na_duration = sum(if_else(is.na(game_duration), 1, 0))) %>%
  ggplot(aes(x = yr, y = na_duration)) + 
  geom_col(width = 1.0, fill = cle_colors["red"], alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  # theme_light() +
  # theme_mlb +
  labs(
    subtitle = "Games with no recorded duration.",
    x = NULL, y = NULL
  )

p1 / p2 + plot_annotation(
  title = "Attendance and duration data is spotty prior to 1940",
  caption = str_wrap("Attendance for game two of a double header is recorded as zero. Plot excludes game two. \nSource: www.baseball-reference.com.", 120)
)
```

As with the attendance data, game duration data is also frequently unavailable prior to 1930.

```{r}
cle_tsibble %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr) %>%
  summarize(na_duration = sum(if_else(is.na(game_duration), 1, 0))) %>%
  ggplot(aes(x = yr, y = na_duration)) + 
  geom_col(width = 1.0, fill = cle_colors["red"], alpha = 0.6) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(title = "Game duration data is spotty until 1930.",
       subtitle = "Games with no recorded duration.",
       x = NULL, y = NULL,
       caption = "source: www.baseball-reference.com.")
```

### Attendance

Is attendance correlated with winning? The answer is usually "yes", except for 1954. The Tribe won 111 games that year, but drew 20,000 per game, a 50% drop from their 1948 pennant-winning season. In a way, it was the 1948-49 seasons that were anomalous. The Tribe had never seen crowds like that before, and wouldn't again until 1995.

```{r}
scale_factor <- 50000
(step_2_fig1 <- cle_tsibble_yr %>%
  # group_by(yr) %>%
  # summarize(attend = mean(if_else(home_ind == "Home", attendance, NA_real_), na.rm = TRUE)) %>%
  mutate(attend = if_else(yr == 2020, 0, home_att)) %>%
  ggplot(aes(x = yr, y = attend)) +
  geom_col(aes(y = 1 * scale_factor), fill = cle_colors["navy_blue"], width = 1, alpha = 0.2) +
  geom_col(aes(y = wins / (wins + losses) * scale_factor), fill = cle_colors["navy_blue"], width = 1, alpha = 0.2) +
  geom_line(color = cle_colors["red"], na.rm = TRUE, linewidth = 1) +
  geom_point(aes(y = if_else(yr %in% c(1920, 1948, 1954, 1995, 1997, 2016), attend, NA_real_)),
             shape = 21, color = cle_colors["red"], fill = "white", size = 3, na.rm = TRUE) +
  # geom_vline(xintercept = c(1920, 1948, 1954, 1995, 1997, 2016), 
  #            color = cle_colors["navy_blue"], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = 0.50 * scale_factor, linetype = 3, linewidth = 1, color = cle_colors["navy_blue"]) +
  annotate(
    geom = "curve", x = 1960, y = 28000, xend = 1954, yend = 22000, 
    curvature = .3, arrow = arrow(length = unit(2, "mm")),
    color = cle_colors["navy_blue"]
  ) +
  annotate("text", x = 1960, y = 28000, label = "where is everyone?", size = 3, 
           hjust = "left", color = cle_colors["navy_blue"]) +
  scale_y_continuous(limits = c(0, NA), 
                     labels = scales::comma,
                     expand = c(0,0),
                     sec.axis = sec_axis(trans = ~ .x / scale_factor,
                                         labels = scales::percent_format(),
                                         name = "Winning Percentage")) +
  scale_x_continuous(breaks = seq(1900, 2030, 10), expand = c(0,0)) +
  # theme_light() +
  labs(x = NULL, y = "Fans per Game",
       title = "Fans love a winner... usually.",
       subtitle = "Annual attendance averages and Cleveland's winning percentage.",
       caption = "source: www.baseball-reference.com.") +
  # theme_mlb +
  theme(axis.text.y.left = element_text(color = cle_colors["red"]),
        axis.title.y.left = element_text(color = cle_colors["red"]))
)
```

As an aside, check out 1917 and 1918. Game attendance does not seem unusual those two years despite WWI and the influenza pandemic. The US entered WWI in Apr '17 and the war ended after the season concluded in '18. The 1918 influenza pandemic started in the spring, but seems to have really taken off around October. Baseball survived the war as an acceptable diversion from civic duty, and in fact patriotic elements were integrated into the games.

### Doubleheaders

Doubleheaders were common through the mid-1960s. Let's take a closer look. Over 50% of baseball games in 1943 were played as part of a doubleheader. Doubleheaders have been relatively rare since the 1980s.

```{r}
cle_tsibble %>%
  mutate(is_dh = if_else(doubleheader_game == 0, 0, 1)) %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr) %>%
  summarize(dh_pct = sum(is_dh) / n()) %>%
  ggplot(aes(x = yr, y = dh_pct)) +
  geom_line(color = cle_colors["red"], linewidth = 1.25, alpha = 0.6) +
  annotation_custom(ball_grob, xmin = 1859, xmax = +Inf, ymin = .52, ymax = .55) +
  annotate(
    geom = "curve", x = 1953, y = .58, xend = 1946, yend = .56, 
    curvature = .3, arrow = arrow(length = unit(2, "mm")),
    color = cle_colors["navy_blue"], linewidth = 1.25
  ) +
  annotate("text", x = 1955, y = .58, label = "51% in 1943!", size = 3, 
           hjust = "left", color = cle_colors["navy_blue"]) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     breaks = seq(0, .6, .1), limits = c(0, .6)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(title = "Let's play one: double-headers are becoming less common",
       subtitle = "Percent of games that were part of a doubleheader.",
       x = NULL, y = NULL,
       caption = "source: www.baseball-reference.com.")
```

### Game Duration

```{r}
max_avg <- cle_tsibble_yr %>% slice_max(order_by = game_hrs9) 
max_hrs <- floor(max_avg %>% pull(game_hrs9))
max_mins <- floor((max_avg %>% pull(game_hrs9) - max_hrs) * 60)
hrs_2021 <- floor(cle_tsibble_yr %>% filter(yr == 2021) %>% pull(game_hrs9))
mins_2021 <- floor((cle_tsibble_yr %>% filter(yr == 2021) %>% pull(game_hrs9) - max_hrs) * 60)
```

If it seems like Tribe games are taking longer to complete, you are right. The annual average game duration has been increasing since 2003. Prior to 2003, it had briefly fallen from an all-time high of `r glue("{max_hrs} hours {max_mins} minutes")` in `r max_avg %>% pull(yr)`. Early in the 1900s, games took a little over an hour and a half, but were increasing and by 1920 game times had climbed over two hours. From 1921 to 1945 game times were steady at about two hours, but began to climb again after WWII, reaching two and half hours by 1955. Game times stabilized at 2.5 hours from 1955 to 1975, before rising again. The average Tribe game time in 2021 was `r glue("{hrs_2021} hours {mins_2021} minutes")`.

```{r}
knot_yrs <- c(1903, 1945, 1978, 2003, 2023)
(step_2_fig2 <- cle_tsibble_yr %>%
   ggplot(aes(x = yr, y = game_hrs9)) +
   annotate("rect", 
            xmin = c(1903, 1945, 1975, 2003), 
            xmax = c(1921, 1955, 2000, 2021), 
            ymin = c(0, 0, 0, 0), ymax = c(3.5, 3.5, 3.5, 3.5), 
            fill = "lightgrey", alpha = 0.6) +
   geom_line(color = cle_colors["red"], size = 1) +
   scale_y_continuous(limits = c(0, NA)) +
   scale_x_continuous(breaks = seq(1900, 2030, 10)) +
   geom_text(data = cle_tsibble_yr %>% filter(yr %in% c(1978, 2023)), aes(label = pretty_hm(game_hrs9)), 
             nudge_y = -.15, size = 3, color = cle_colors["red"], hjust = 0) + 
   geom_point(data = cle_tsibble_yr %>% filter(yr %in% c(1978, 2023)), 
              color = cle_colors["red"], size = 2) + 
   labs(x = NULL, y = "Hours",
        title = "How long have we been sitting here?",
        subtitle = "Cleveland Indians average game duration, with periods of growth and stability.",
        caption = "source: www.baseball-reference.com.")
)
```

```{r}
double_header_effect <- cle_tsibble %>%
  mutate(is_doubleheader = if_else(doubleheader_game == 0, "Single", "Twin Bill")) %>%
  # average over the day (in case of doubleheaders)
  index_by(yr = ~ year(.)) %>%
  group_by(yr, is_doubleheader) %>%
  summarize(game_hrs9 = mean(game_hrs9, na.rm = TRUE)) 

double_header_effect_wide <- double_header_effect %>%
  pivot_wider(names_from = is_doubleheader, values_from = game_hrs9) %>%
  mutate(twin_diff = `Twin Bill` - Single)

```

Doubleheaders have become less common while game times have increased. Is there a negative correlation, perhaps a compensating effect? Let's print the same chart, but control for whether the game is part of a doubleheader. The answer is no, doubleheaders are irrelevant. The average doubleheader game is shorter by all of `r scales::comma(mean(double_header_effect_wide$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)` minutes.

```{r}
double_header_effect %>%
  ggplot(aes(x = yr, y = game_hrs9, color = is_doubleheader)) +
  annotate("rect", 
           xmin = c(1903, 1945, 1975, 2003), 
           xmax = c(1921, 1955, 2000, 2021), 
           ymin = c(0, 0, 0, 0), ymax = c(3.5, 3.5, 3.5, 3.5), 
           fill = "lightgrey", alpha = 0.6) +
  geom_line(size = 1) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  scale_color_manual(values = all_colors) +
  labs(x = NULL, y = "Hours",
       title = "Players don't rush through doubleheaders.",
       subtitle = glue("Doubleheader games are shorter by only {scales::comma(mean(double_header_effect_wide$twin_diff, na.rm = TRUE) * 60 * (-1), accuracy = 1)} minutes on average."),
       caption = "source: www.baseball-reference.com.",
       color = NULL)
```

```{r}
day_night <- cle_tsibble %>%
  index_by(yr = ~ year(.)) %>%
  group_by(yr, day_ind) %>%
  summarize(game_hrs9 = mean(game_hrs9, na.rm = TRUE),
            n = n())
```

How about day games? Until the late 1930s, all games were played in the afternoon. By the mid 1970s day games were primarily on weekends. While there might be a different dynamic to paying in the afternoon (*it's hot - let's get out of here!*), the data doesn't bear that out. The advent of night games is not associated with longer games.

```{r}
(step_2_fig3 <- day_night %>%
  ggplot(aes(x = yr)) +
  annotate("rect", 
           xmin = c(1903, 1945, 1975, 2003), 
           xmax = c(1921, 1955, 2000, 2021), 
           ymin = c(0, 0, 0, 0), ymax = c(3.5, 3.5, 3.5, 3.5), 
           fill = "lightgrey", alpha = 0.6) +
  geom_col(aes(y = n / 200, fill = day_ind), alpha = 0.2, width = 1.0) +
  # geom_point(aes(y = game_hrs9, color = day_ind), size = .025) +
  geom_line(aes(y = game_hrs9, color = day_ind), size = 1, alpha = 0.6) +
  annotate("text", x = 1910, y = .58, label = "Count of games", size = 3, 
           hjust = "left", color = cle_colors["navy_blue"], alpha = 0.8) +
  scale_color_manual(values = all_colors) +
  scale_fill_manual(values = all_colors) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Night games are more common, but they're not longer.",
       subtitle = "Cleveland Indians average game duration, with periods of growth and stability.",
       caption = "source: www.baseball-reference.com.")
)
```

I'm curious about the dip in game duration between 2000 and 2003. Game duration reached its peak at `r cle_tsibble_yr %>% filter(yr == 2000) %>% pull(game_hrs9) %>% pretty_hm()` per game in 2000. Then it underwent a brief period of decline, falling to `r cle_tsibble_yr %>% filter(yr == 2003) %>% pull(game_hrs9) %>% pretty_hm()` in 2003. It climbed back to `r cle_tsibble_yr %>% filter(yr == 2021) %>% pull(game_hrs9) %>% pretty_hm()` in 2021. I wonder if the reduction in offense after the steroid era is related. Below is the trend of average game times with total runs scored. They both plummeted over that three year period, but they've been moving in opposite directions since 2010. 

```{r}
(step_2_fig4 <- cle_tsibble_yr %>%
  ggplot(aes(x = yr)) +
  annotate("rect", xmin = 2000, xmax = 2003, ymin = 0, ymax = 3.5, fill = "lightgrey", alpha = 0.6) +
  geom_line(aes(y = game_hrs9), size = 1, alpha = 0.6, color = cle_colors["red"]) +
  geom_col(aes(y = runs9/5), width = 1.0, fill = cle_colors["navy_blue"], alpha = 0.2) +
  # geom_point(aes(y = game_hrs9, color = day_ind), size = .025) +
  annotate("text", x = 1910, y = .58, label = "Runs per 9 innings", size = 3, 
           hjust = "left", color = cle_colors["navy_blue"], alpha = 0.8) +
  scale_y_continuous(limits = c(0, NA), sec.axis = sec_axis(~ . * 5, name = "Runs")) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(x = NULL, y = "Hours", color = NULL, fill = NULL,
       title = "Game times fell after the steroid era.",
       subtitle = "Cleveland Indians average game duration, runs per game.",
       caption = "source: www.baseball-reference.com.") +
   theme(
     axis.text.y.left = element_text(color = cle_colors["red"]),
     axis.title.y.left = element_text(color = cle_colors["red"]),
     plot.caption = element_text(family = "Calibri Light", size = 11)
   )
)
```

Incidentally, compare the offense in the 1930s to the steroid era of the 1990s. And there's that year of the pitcher, 1968. But then 1972 does not look so hot. It should be noted that these are just Cleveland Indians games. There may be seasons when the Tribe had decent pitching, but no hitting, or vice-versa (or, sadly, neither).

### Duration Trends

Average game duration does not appear to change much within seasons - it looks like it falls about .2 hours (12 minutes) over the course of the season. The apparent increase in March game times is an artifact of March games not occurring until 1998. 

```{r warning=FALSE}
cle_tsibble_yrmo <- cle_tsibble %>%
  index_by(yrmo = ~ yearmonth(.)) %>%
  summarize(game_hrs9 = mean(game_hrs9, na.rm = TRUE))

cle_tsibble_mmm <- cle_tsibble %>%
  index_by(mmm = ~ month(.)) %>%
  summarize(game_hrs9 = mean(game_hrs9, na.rm = TRUE)) %>%
  mutate(mmm = ym(paste0("9999-", mmm))) 

ggplot() +
  geom_line(data = cle_tsibble_yrmo,
            aes(x = month(yrmo, label = TRUE, abbr = TRUE), y = game_hrs9,
                group = factor(year(yrmo)), color = year(yrmo)),
            show.legend = TRUE, alpha = 0.2) +
  scale_color_gradient(low = all_colors[6], high = all_colors[2]) +
  geom_line(data = cle_tsibble_mmm,
            aes(x = month(mmm, label = TRUE, abbr = TRUE), y = game_hrs9,
                group = factor(year(mmm))), 
            alpha = 0.8) +
  scale_y_continuous(limits = c(0, NA)) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.25)) +
  labs(title = "Game duration falls slightly within a season.",
       subtitle = "Average game duration by month of season. Bold line is average.", 
       x = NULL, y = "Hours", color = NULL,
       caption = "source: www.baseball-reference.com.")
```

### Benchmark Forecasts

The following sections will use time series analysis to forecast attendance. Some forecasting methods are extremely simple and surprisingly effective. I'll keep them in mind as benchmarks to evaluate the more sophisticated methods. I denote a forecast value with the "hat" notation, $\hat{y}_{T+h|T}$. The subscript $T + h$ means forecasting $h$ periods beyond the observed time series $T$. $\hat{y}_{T+h|T}$ means an $h$ period forecast beyond $T$ based on data through period $T$.

* The **average method** projects the historical average, $\hat{y}_{T+h|T} = \bar{y}.$ 
* The **naive method** projects the last observation, $\hat{y}_{T+h|T} = y_T.$ 
* The **seasonal naive method** projects the last seasonal observation, $\hat{y}_{T+h|T} = y_{T+h-m(k+1)}$. 

The methods can include drift, a straight line from the first and last observation, $\hat{y}_{T+h|T} = y_T + h\left(\frac{y_T - y_1}{T-1}\right).$

```{r warning=FALSE}
cle_tsibble_yr %>%
  # fill_gaps() %>%
  model(Average = MEAN(game_hrs9),
        Naive = NAIVE(game_hrs9),
        RW = RW(game_hrs9 ~ drift())) %>%
  forecast(h = 10) %>%
  ggplot(aes(x = yr)) +
  geom_line(aes(y = .mean, color = .model)) +
  geom_line(data = cle_tsibble_yr %>% filter(yr >= 1911) %>% fill_gaps(), aes(y = game_hrs9)) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  labs(title = "Three benchmark Tribe game duration forecasts.",
       subtitle = "Average, naive, and random walk forecasts, h = 10 seasons.", 
       x = NULL, y = "Hours", color = NULL,
       caption = "source: www.baseball-reference.com.") +
  guides(color = guide_legend(title = "Forecast"))
```

```{r}
saveRDS(cle_tsibble_yr, "../data/cle_tsibble_yr.rds")
# save(
#   step_2_fig1, step_2_fig2, step_2_fig3, step_2_fig4, scale_factor,
#   file = "step_2.RData"
# )
```
